{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "f3c4e9cb-8f5c-45ef-9ff9-9517d2a4aa19",
            "version": "KqlParameterItem/1.0",
            "name": "Resource",
            "label": "ADX-Cluster",
            "type": 5,
            "isRequired": true,
            "value": "value::1",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.kusto/clusters": true
              },
              "additionalResourceOptions": [
                "value::1"
              ]
            }
          },
          {
            "id": "182d6324-854c-4cc0-802a-de4f3bee9f76",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                }
              ],
              "allowCustom": true
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.kusto/clusters"
      },
      "name": "parameters - 0",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{Resource}"
        ],
        "parameters": [
          {
            "id": "aae60b9f-7b11-4c85-a963-81bfcf6b85c1",
            "version": "KqlParameterItem/1.0",
            "name": "Usage",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "let commands_table = view () { ADXCommand  | take 1 };\r\nlet queries_table = view () { ADXQuery  | take 1};\r\nunion withsource=TableName commands_table, queries_table ",
            "crossComponentResources": [
              "{Resource}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 0
            },
            "timeContextFromParameter": "TimeRange",
            "queryType": 0,
            "resourceType": "microsoft.kusto/clusters",
            "value": [
              "queries_table",
              "commands_table"
            ]
          }
        ],
        "style": "above",
        "queryType": 0,
        "resourceType": "microsoft.kusto/clusters"
      },
      "conditionalVisibility": {
        "parameterName": "1",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "name": "parameters - 4"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "Overview",
            "subTarget": "Overview",
            "style": "link"
          },
          {
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "Key Metrics",
            "subTarget": "Cluster",
            "style": "link"
          },
          {
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "Commands and Queries",
            "subTarget": "Commands",
            "style": "link"
          }
        ]
      },
      "name": "Tabs",
      "styleSettings": {
        "margin": "-15px 0px -15px 0px"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 10,
            "content": {
              "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
              "version": "MetricsItem/2.0",
              "size": 3,
              "chartType": -1,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Cluster health-KeepAlive",
                  "aggregation": 4,
                  "columnName": "Keep Alive (Avg)"
                }
              ],
              "gridFormatType": 1,
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1,
                  "tooltipFormat": {
                    "tooltip": "An average Keep Alive below 0.995 (over a long period) may indicate a health issue or may indicate that your cluster was suspended (Pay attention to your time range. This rule is important over a long period). This tile shows up to 4 significant digits."
                  }
                },
                "subtitleContent": {
                  "columnMatch": "Value",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "icons",
                    "thresholdsGrid": [
                      {
                        "operator": "<=",
                        "thresholdValue": "0.995",
                        "representation": "2",
                        "text": ""
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "success",
                        "text": ""
                      }
                    ]
                  },
                  "tooltipFormat": {
                    "tooltip": "An average Keep Alive below 0.995 (over a long period) may indicate a health issue or may indicate that your cluster was suspended (Pay attention to your time range. This rule is important over a long period). This tile shows up to 4 significant digits."
                  }
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false,
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 4
                    }
                  },
                  "tooltipFormat": {
                    "tooltip": "An average Keep Alive below 0.995 (over a long period) may indicate a health issue or may indicate that your cluster was suspended (Pay attention to your time range. This rule is important over a long period). This tile shows up to 4 significant digits."
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Timeline",
                  "formatter": 9,
                  "formatOptions": {
                    "min": 0,
                    "max": 1,
                    "palette": "blue"
                  },
                  "tooltipFormat": {
                    "tooltip": "An average Keep Alive below 0.995 (over a long period) may indicate a health issue or may indicate that your cluster was suspended (Pay attention to your time range. This rule is important over a long period). This tile shows up to 4 significant digits."
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "gridSettings": {
                "rowLimit": 10000
              },
              "sortBy": []
            },
            "customWidth": "0",
            "showPin": false,
            "name": "summary tiles"
          },
          {
            "type": 10,
            "content": {
              "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
              "version": "MetricsItem/2.0",
              "size": 3,
              "chartType": -1,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Cluster health-CPU",
                  "aggregation": 4,
                  "columnName": "CPU (Avg)"
                }
              ],
              "gridFormatType": 1,
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1,
                  "tooltipFormat": {
                    "tooltip": "An average CPU of 80% or less (over a long period) is sustainable for a cluster"
                  }
                },
                "subtitleContent": {
                  "columnMatch": "Value",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "icons",
                    "thresholdsGrid": [
                      {
                        "operator": ">=",
                        "thresholdValue": "80",
                        "representation": "2",
                        "text": ""
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "0",
                        "representation": "Normal",
                        "text": ""
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "success",
                        "text": ""
                      }
                    ]
                  },
                  "tooltipFormat": {
                    "tooltip": "An average CPU of 80% or less (over a long period) is sustainable for a cluster"
                  }
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false,
                      "maximumFractionDigits": 4
                    }
                  },
                  "tooltipFormat": {
                    "tooltip": "An average CPU of 80% or less (over a long period) is sustainable for a cluster"
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Timeline",
                  "formatter": 9,
                  "formatOptions": {
                    "min": 0,
                    "max": 100,
                    "palette": "blue"
                  },
                  "tooltipFormat": {
                    "tooltip": "An average CPU of 80% or less is sustainable for a cluster (over a long time period)"
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "gridSettings": {
                "rowLimit": 10000
              },
              "sortBy": []
            },
            "customWidth": "0",
            "showPin": false,
            "name": "summary tiles",
            "styleSettings": {
              "margin": "0px"
            }
          },
          {
            "type": 10,
            "content": {
              "chartId": "workbookc80219c7-4cf9-4a69-be8f-b72305af2789",
              "version": "MetricsItem/2.0",
              "size": 3,
              "chartType": -1,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Cluster health-IngestionUtilization",
                  "aggregation": 4,
                  "columnName": "Ingestion Utilization (Avg)"
                }
              ],
              "gridFormatType": 1,
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 13,
                  "formatOptions": {
                    "linkTarget": null,
                    "showIcon": false
                  },
                  "tooltipFormat": {
                    "tooltip": "Percentage of actual resources used to ingest data from the total resources allocated, in the capacity policy, to perform ingestion.  An average ingestion utilization of 80% or less (over a long period) is a sustainable state for a cluster."
                  }
                },
                "subtitleContent": {
                  "columnMatch": "Value",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "icons",
                    "thresholdsGrid": [
                      {
                        "operator": ">=",
                        "thresholdValue": "80",
                        "representation": "2",
                        "text": ""
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "success",
                        "text": ""
                      }
                    ]
                  },
                  "tooltipFormat": {
                    "tooltip": "Percentage of actual resources used to ingest data from the total resources allocated, in the capacity policy, to perform ingestion.  An average ingestion utilization of 80% or less (over a long period) is a sustainable state for a cluster."
                  }
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "none"
                  },
                  "numberFormat": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false,
                      "maximumFractionDigits": 4
                    }
                  },
                  "tooltipFormat": {
                    "tooltip": "Percentage of actual resources used to ingest data from the total resources allocated, in the capacity policy, to perform ingestion.  An average ingestion utilization of 80% or less (over a long period) is a sustainable state for a cluster."
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Timeline",
                  "formatter": 9,
                  "formatOptions": {
                    "min": 0,
                    "max": 100,
                    "palette": "blue"
                  },
                  "tooltipFormat": {
                    "tooltip": "Percentage of actual resources used to ingest data from the total resources allocated, in the capacity policy, to perform ingestion.  An average ingestion utilization of 80% or less (over a long period) is a sustainable state for a cluster."
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "gridSettings": {
                "rowLimit": 10000
              }
            },
            "customWidth": "0",
            "showPin": false,
            "name": "metric"
          },
          {
            "type": 10,
            "content": {
              "chartId": "workbookc80219c7-4cf9-4a69-be8f-b72305af2789",
              "version": "MetricsItem/2.0",
              "size": 3,
              "chartType": -1,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Ingestion health and performance-IngestionLatencyInSeconds",
                  "aggregation": 4,
                  "columnName": "Ingestion Latency (Avg)"
                }
              ],
              "gridFormatType": 1,
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 13,
                  "formatOptions": {
                    "linkTarget": null,
                    "showIcon": false
                  },
                  "tooltipFormat": {
                    "tooltip": "The ingestion latency period depends on the ingestion scenario. As a \"rule of thumb\", an average Ingestion Latency above 15 minutes  (over a long period) may indicate a problem"
                  }
                },
                "subtitleContent": {
                  "columnMatch": "Value",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "icons",
                    "thresholdsGrid": [
                      {
                        "operator": ">=",
                        "thresholdValue": "900",
                        "representation": "2",
                        "text": ""
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "success",
                        "text": ""
                      }
                    ]
                  },
                  "tooltipFormat": {
                    "tooltip": "The ingestion latency period depends on the ingestion scenario. As a \"rule of thumb\", an average Ingestion Latency above 15 minutes  (over a long period) may indicate a problem"
                  }
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 12,
                  "numberFormat": {
                    "unit": 24,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false,
                      "maximumFractionDigits": 2
                    }
                  },
                  "tooltipFormat": {
                    "tooltip": "The ingestion latency period depends on the ingestion scenario. As a \"rule of thumb\", an average Ingestion Latency above 15 minutes  (over a long period) may indicate a problem"
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Timeline",
                  "formatter": 9,
                  "formatOptions": {
                    "palette": "blue"
                  },
                  "tooltipFormat": {
                    "tooltip": "The ingestion latency period depends on the ingestion scenario. As a \"rule of thumb\", an average Ingestion Latency above 15 minutes  (over a long period) may indicate a problem"
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "gridSettings": {
                "rowLimit": 10000
              }
            },
            "customWidth": "0",
            "showPin": false,
            "name": "metric - 13"
          },
          {
            "type": 10,
            "content": {
              "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
              "version": "MetricsItem/2.0",
              "size": 3,
              "chartType": -1,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Cluster health-CacheUtilization",
                  "aggregation": 4,
                  "columnName": "Cache Utilization (Avg)"
                }
              ],
              "gridFormatType": 1,
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1,
                  "tooltipFormat": {
                    "tooltip": "An average cache utilization of 80% or less (over a long period) is a sustainable state for a cluster. If the average cache utilization is above 80% (over a long period), the cluster should be scaled up to a storage optimized pricing tier or scaled out to more instances. Alternatively, adapt the cache policy (fewer days in cache)."
                  }
                },
                "subtitleContent": {
                  "columnMatch": "Value",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "icons",
                    "thresholdsGrid": [
                      {
                        "operator": ">=",
                        "thresholdValue": "80",
                        "representation": "2",
                        "text": ""
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "success",
                        "text": ""
                      }
                    ]
                  },
                  "tooltipFormat": {
                    "tooltip": "An average cache utilization of 80% or less (over a long period) is a sustainable state for a cluster. If the average cache utilization is above 80% (over a long period), the cluster should be scaled up to a storage optimized pricing tier or scaled out to more instances. Alternatively, adapt the cache policy (fewer days in cache)."
                  }
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false,
                      "maximumFractionDigits": 2
                    }
                  },
                  "tooltipFormat": {
                    "tooltip": "An average cache utilization of 80% or less (over a long period) is a sustainable state for a cluster. If the average cache utilization is above 80% (over a long period), the cluster should be scaled up to a storage optimized pricing tier or scaled out to more instances. Alternatively, adapt the cache policy (fewer days in cache)."
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Timeline",
                  "formatter": 9,
                  "formatOptions": {
                    "min": 0,
                    "max": 100,
                    "palette": "blue"
                  },
                  "tooltipFormat": {
                    "tooltip": "An average cache utilization of 80% or less (over a long period) is a sustainable state for a cluster. If the average cache utilization is above 80% (over a long period), the cluster should be scaled up to a storage optimized pricing tier or scaled out to more instances. Alternatively, adapt the cache policy (fewer days in cache)."
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "gridSettings": {
                "rowLimit": 10000
              },
              "sortBy": []
            },
            "customWidth": "0",
            "showPin": false,
            "name": "Cache Utilization"
          },
          {
            "type": 10,
            "content": {
              "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
              "version": "MetricsItem/2.0",
              "size": 3,
              "chartType": -1,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Ingestion health and performance-IngestionResult",
                  "aggregation": 7,
                  "columnName": "Succeeded Ingestions (#)"
                }
              ],
              "gridFormatType": 1,
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1,
                  "tooltipFormat": {
                    "tooltip": "Total number of ingestion operations that succeeded"
                  }
                },
                "subtitleContent": {
                  "columnMatch": "Value",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "icons",
                    "thresholdsGrid": [
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "Normal",
                        "text": ""
                      }
                    ]
                  },
                  "tooltipFormat": {
                    "tooltip": "Total number of ingestion operations that succeeded"
                  }
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false,
                      "maximumFractionDigits": 2
                    }
                  },
                  "tooltipFormat": {
                    "tooltip": "Total number of ingestion operations that succeeded"
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Timeline",
                  "formatter": 9,
                  "formatOptions": {
                    "min": 0,
                    "max": 100,
                    "palette": "blue"
                  },
                  "tooltipFormat": {
                    "tooltip": "Total number of ingestion operations that succeeded"
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "filters": [
                {
                  "id": "2",
                  "key": "IngestionResultDetails",
                  "operator": 0,
                  "values": [
                    "Success"
                  ]
                }
              ],
              "gridSettings": {
                "rowLimit": 10000
              },
              "sortBy": []
            },
            "customWidth": "0",
            "showPin": false,
            "name": "succeeded ingestions"
          },
          {
            "type": 10,
            "content": {
              "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
              "version": "MetricsItem/2.0",
              "size": 3,
              "chartType": -1,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Ingestion health and performance-IngestionResult",
                  "aggregation": 7,
                  "columnName": "Failed Ingestions (#)"
                }
              ],
              "gridFormatType": 1,
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1,
                  "tooltipFormat": {
                    "tooltip": "Total number of ingestion operations that failed (every ingestion operation that was not succeeded)"
                  }
                },
                "subtitleContent": {
                  "columnMatch": "Value",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "icons",
                    "thresholdsGrid": [
                      {
                        "operator": ">",
                        "thresholdValue": "0",
                        "representation": "2",
                        "text": ""
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "Blank",
                        "text": ""
                      }
                    ]
                  },
                  "tooltipFormat": {
                    "tooltip": "Total number of ingestion operations that failed (every ingestion operation that was not succeeded)"
                  }
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false,
                      "maximumFractionDigits": 2
                    }
                  },
                  "tooltipFormat": {
                    "tooltip": "Total number of ingestion operations that failed (every ingestion operation that was not succeeded)"
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Timeline",
                  "formatter": 9,
                  "formatOptions": {
                    "min": 0,
                    "max": 100,
                    "palette": "blue"
                  },
                  "tooltipFormat": {
                    "tooltip": "Total number of ingestion operations that failed (every ingestion operation that was not succeeded)"
                  }
                },
                "showBorder": false,
                "size": "full"
              },
              "filters": [
                {
                  "id": "1",
                  "key": "IngestionResultDetails",
                  "operator": 1,
                  "values": [
                    "Success"
                  ]
                }
              ],
              "gridSettings": {
                "rowLimit": 10000
              },
              "sortBy": []
            },
            "customWidth": "0",
            "showPin": false,
            "name": "succeeded ingestions - Copy"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "f27feb91-b0a0-461d-88be-2ee75b5a2f14",
                        "version": "KqlParameterItem/1.0",
                        "name": "include_sys_op_param",
                        "label": "System Operations",
                        "type": 2,
                        "description": "System Operations (Data Management) are used for ingestion and other cluster management aspects",
                        "isRequired": true,
                        "value": "true",
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n{ \"value\": \"false\", \"label\": \"Do Not Include Data Management Operations\", \"selected\": \"true\" }, \r\n{ \"value\": \"true\", \"label\": \"Include Data Management Operations\", \"selected\": \"false\" }\r\n]",
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters"
                  },
                  "customWidth": "100",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "parameters - 6"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is KustoRunner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand \r\n| where TimeGenerated > datetime(2020-09-09T09:30:00Z) \r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_sys_op_param} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_sys_op_param} == \"true\")\r\n| extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak) \r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_sys_op_param} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_sys_op_param} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State, FailureReason, RootActivityId, User, ApplicationName, Principal, TotalCPU, MemoryPeak, CorrelationId, cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}'\r\n    //| where totimespan(TotalCPU) > totimespan(0)\r\n    | summarize TotalCPU=max(TotalCPU) \r\n  , MemoryPeak=max(MemoryPeak) by User, ApplicationName, CorrelationId \r\n;\r\nlet totalCPU = toscalar(dataset | summarize sum((totimespan(TotalCPU)/1s)));\r\nlet totalMemory = toscalar(dataset | summarize sum(MemoryPeak));\r\nlet topMemory = \r\n    dataset\r\n    | top-nested 10000 of User with others=\"Others\" by sum(MemoryPeak), top-nested 10000 of ApplicationName with others=\"Others\" by sum(MemoryPeak)\r\n    | extend PercentOfTotalClusterMemoryUsed = aggregated_ApplicationName/toreal(totalMemory)\r\n;\r\nlet topCpu = \r\n    dataset\r\n    | top-nested 10000 of User with others=\"Others\" by sum(totimespan(TotalCPU)/1s), top-nested 10000 of ApplicationName with others=\"Others\" by sum(totimespan(TotalCPU)/1s)\r\n    | extend PercentOfTotalClusterCpuUsed = aggregated_ApplicationName/toreal(totalCPU)\r\n;\r\ntopMemory\r\n| join kind = fullouter(topCpu) on User, ApplicationName\r\n| extend BothPercentages = PercentOfTotalClusterMemoryUsed+PercentOfTotalClusterCpuUsed\r\n| top 20 by BothPercentages desc\r\n| extend User = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", strcat(\"Kusto Data Management \",\"(\",User,\")\"),\r\nApplicationName==\"KustoQueryRunner\", strcat(\"Kusto Query Runner \",\"(\",User,\")\"),\r\nUser==\"AAD app id=e0331ea9-83fc-4409-a17d-6375364c3280\", \"DataMap Agent 001 (app id: e0331ea9-83fc-4409-a17d-6375364c3280)\", // Used for internal MS clusters \r\nUser)\r\n| where not (ApplicationName == \"Others\" and PercentOfTotalClusterMemoryUsed == 0 and PercentOfTotalClusterCpuUsed == 0)\r\n| project User, ApplicationName, PercentOfTotalClusterMemoryUsed * 100 , PercentOfTotalClusterCpuUsed * 100",
                    "size": 3,
                    "title": "Top Resource Consumers",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Column1",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blue"
                          },
                          "numberFormat": {
                            "unit": 1,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false
                            }
                          },
                          "tooltipFormat": {
                            "tooltip": "Percent Of Total Cluster Memory Used"
                          }
                        },
                        {
                          "columnMatch": "Column2",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blue"
                          },
                          "numberFormat": {
                            "unit": 1,
                            "options": {
                              "style": "decimal"
                            }
                          },
                          "tooltipFormat": {
                            "tooltip": "Percent Of Total Cluster CPU Used"
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "ApplicationName",
                          "label": "Application"
                        },
                        {
                          "columnId": "Column1",
                          "label": "% of Used Cluster Memory",
                          "comment": "Relative portion of the actual cluster memory consumption"
                        },
                        {
                          "columnId": "Column2",
                          "label": "% of Used Cluster CPU",
                          "comment": "Relative portion of the actual CPU consumption"
                        }
                      ]
                    },
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "User",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Column1",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "User",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "Column1",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "chartSettings": {
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 1,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "60",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Top Resource Consumers - Overview"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak) \r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where ApplicationName != 'Kusto.WinSvc.DM.Svc'\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where ApplicationName != 'Kusto.WinSvc.DM.Svc'\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User,\r\nApplicationName,\r\nPrincipal,\r\nTotalCPU,\r\nMemoryPeak,\r\nCorrelationId,\r\ncluster_name;\r\nlet raw = dataset_commands_queries\r\n    | where LastUpdatedOn {TimeRange}\r\n    | where cluster_name == '{Resource:name}'\r\n    | where StartedOn > ago(365d)\r\n;\r\nraw\r\n| evaluate activity_engagement(User, StartedOn, 1d, 7d)\r\n| join kind = inner (\r\n    raw\r\n    | evaluate activity_engagement(User, StartedOn, 1d, 30d)\r\n    ) on StartedOn\r\n| project StartedOn, Daily=dcount_activities_inner, Weekly=dcount_activities_outer, Monthly = dcount_activities_outer1     \r\n| where StartedOn > ago(90d)\r\n| project Daily,StartedOn,Weekly,Monthly | sort by StartedOn asc\r\n",
                    "size": 0,
                    "aggregation": 3,
                    "title": "Unique User Count  (Over a sliding timeline window. Not affected by the parameters)",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Column1",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blue"
                          },
                          "numberFormat": {
                            "unit": 1,
                            "options": {
                              "style": "decimal"
                            }
                          },
                          "tooltipFormat": {
                            "tooltip": "Percent Of Total Cluster Memory Used"
                          }
                        },
                        {
                          "columnMatch": "Column2",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blue"
                          },
                          "numberFormat": {
                            "unit": 1,
                            "options": {
                              "style": "decimal"
                            }
                          },
                          "tooltipFormat": {
                            "tooltip": "Percent Of Total Cluster CPU Used"
                          }
                        }
                      ]
                    },
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "User",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Column1",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "User",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "Column1",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "chartSettings": {
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "40",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "query usage"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "💡 This table shows the distribution of the memory/CPU consumption, relative to the actual memory and CPU consumption of the cluster. </BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;More details can be found on the Commands and Queries tab"
                  },
                  "customWidth": "60",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "More Info"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "###### Heaviest Resource Consumers "
                  },
                  "customWidth": "45",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isEqualTo"
                  },
                  "name": "Heaviest User Count Header"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "###### Unique User Count"
                  },
                  "customWidth": "40",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isEqualTo"
                  },
                  "name": "Unique User Count"
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "This section provides additional monitoring coverage that is based on platform logs (diagnostic logs).</br>Either you have not enabled the logs or there is no log data for this resource in the Log Analytics workapsce. [Learn more](https://docs.microsoft.com/en-us/azure/data-explorer/using-diagnostic-logs?tabs=commands-and-queries#set-up-diagnostic-logs-for-an-azure-data-explorer-cluster)",
                          "style": "upsell"
                        },
                        "customWidth": "60",
                        "showPin": false,
                        "name": "text - 2"
                      },
                      {
                        "type": 11,
                        "content": {
                          "version": "LinkItem/1.0",
                          "style": "paragraph",
                          "links": [
                            {
                              "cellValue": "{Resource}",
                              "linkTarget": "Resource",
                              "linkLabel": "Enable Logs for Monitoring",
                              "subTarget": "diagnostics",
                              "preText": "",
                              "postText": "",
                              "style": "primary"
                            }
                          ]
                        },
                        "customWidth": "70",
                        "name": "links - 8"
                      }
                    ]
                  },
                  "customWidth": "90",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isEqualTo"
                  },
                  "name": "Onboarding Message"
                }
              ]
            },
            "name": "expander",
            "styleSettings": {
              "padding": "10px"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "Overview"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Cluster",
        "items": [
          {
            "type": 10,
            "content": {
              "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
              "version": "MetricsItem/2.0",
              "size": 1,
              "chartType": 2,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Cluster health-KeepAlive",
                  "aggregation": 4,
                  "splitBy": null
                }
              ],
              "title": "Keep Alive",
              "showOpenInMe": true,
              "gridSettings": {
                "rowLimit": 10000
              },
              "sortBy": [],
              "showExportToExcel": true
            },
            "customWidth": "25",
            "showPin": false,
            "name": "keep alive"
          },
          {
            "type": 10,
            "content": {
              "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
              "version": "MetricsItem/2.0",
              "size": 1,
              "chartType": 2,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Cluster health-CPU",
                  "aggregation": 4,
                  "splitBy": null
                }
              ],
              "title": "CPU",
              "showOpenInMe": true,
              "gridSettings": {
                "rowLimit": 10000
              },
              "sortBy": [],
              "showExportToExcel": true
            },
            "customWidth": "25",
            "showPin": false,
            "name": "CPU"
          },
          {
            "type": 10,
            "content": {
              "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
              "version": "MetricsItem/2.0",
              "size": 1,
              "chartType": 2,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Cluster health-CacheUtilization",
                  "aggregation": 4,
                  "splitBy": null
                }
              ],
              "title": "Cache Utilization",
              "showOpenInMe": true,
              "gridSettings": {
                "rowLimit": 10000
              },
              "sortBy": [],
              "showExportToExcel": true
            },
            "customWidth": "25",
            "showPin": false,
            "name": "cache"
          },
          {
            "type": 10,
            "content": {
              "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
              "version": "MetricsItem/2.0",
              "size": 1,
              "chartType": 2,
              "resourceType": "microsoft.kusto/clusters",
              "metricScope": 0,
              "resourceParameter": "Resource",
              "resourceIds": [
                "{Resource}"
              ],
              "timeContextFromParameter": "TimeRange",
              "timeContext": {
                "durationMs": 604800000
              },
              "metrics": [
                {
                  "namespace": "microsoft.kusto/clusters",
                  "metric": "microsoft.kusto/clusters-Cluster health-InstanceCount",
                  "aggregation": 4,
                  "splitBy": null
                }
              ],
              "title": "Instance Count",
              "showOpenInMe": true,
              "gridSettings": {
                "rowLimit": 10000
              },
              "sortBy": [],
              "showExportToExcel": true
            },
            "customWidth": "25",
            "showPin": false,
            "name": "Instance Count"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Queries",
              "expandable": true,
              "expanded": true,
              "items": [
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Query performance-TotalNumberOfConcurrentQueries",
                        "aggregation": 4,
                        "splitBy": null
                      }
                    ],
                    "title": "Concurrent Queries ",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Concurrent Queries "
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Query performance-QueryDuration",
                        "aggregation": 4,
                        "splitBy": "QueryStatus"
                      }
                    ],
                    "title": "Query Duration",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "keep alive"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Cluster health-TotalNumberOfThrottledCommands",
                        "aggregation": 4,
                        "splitBy": null,
                        "columnName": "Throttled Commands"
                      }
                    ],
                    "title": "Throttled Commands",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Throttled Commands"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Query performance-TotalNumberOfThrottledQueries",
                        "aggregation": 4,
                        "splitBy": null,
                        "columnName": "Throttled queries"
                      }
                    ],
                    "title": "Throttled Queries",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Throttled Queries"
                }
              ]
            },
            "name": "Queries Internal",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Ingestion",
              "expandable": true,
              "items": [
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Cluster health-IngestionUtilization",
                        "aggregation": 4,
                        "splitBy": null
                      }
                    ],
                    "title": "Ingestion Utilization",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "ingestion"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Ingestion health and performance-IngestionLatencyInSeconds",
                        "aggregation": 4,
                        "splitBy": null
                      }
                    ],
                    "title": "Ingestion Latency",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Ingestion Latency"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Ingestion health and performance-IngestionResult",
                        "aggregation": 7,
                        "splitBy": "IngestionResultDetails"
                      }
                    ],
                    "title": "Ingestion Result",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Ingestion Result"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Ingestion health and performance-IngestionVolumeInMB",
                        "aggregation": 1,
                        "splitBy": null
                      }
                    ],
                    "title": "Ingestion Volume",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Ingestion Volume"
                }
              ]
            },
            "name": "Ingestion Internal Group",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Streaming Ingestion",
              "expandable": true,
              "items": [
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Streaming Ingest-StreamingIngestDataRate",
                        "aggregation": 4,
                        "splitBy": null
                      }
                    ],
                    "title": "Streaming Ingest Data Rate",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Streaming Ingest Data Rate"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Streaming Ingest-StreamingIngestDuration",
                        "aggregation": 4,
                        "splitBy": null
                      }
                    ],
                    "title": "Streaming Ingest Duration",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Streaming Ingest Duration"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Streaming Ingest-SteamingIngestRequestRate",
                        "aggregation": 7,
                        "splitBy": null,
                        "columnName": "Streaming Ingest Request Rate (Total number of streaming ingestion requests)"
                      }
                    ],
                    "title": "Streaming Ingest Request Rate",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Streaming Ingest Request Rate"
                },
                {
                  "type": 10,
                  "content": {
                    "chartId": "workbook19356bdc-cfd5-47c7-8e70-05bbd3f39558",
                    "version": "MetricsItem/2.0",
                    "size": 1,
                    "chartType": 2,
                    "resourceType": "microsoft.kusto/clusters",
                    "metricScope": 0,
                    "resourceParameter": "Resource",
                    "resourceIds": [
                      "{Resource}"
                    ],
                    "timeContextFromParameter": "TimeRange",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "metrics": [
                      {
                        "namespace": "microsoft.kusto/clusters",
                        "metric": "microsoft.kusto/clusters-Streaming Ingest-StreamingIngestResults",
                        "aggregation": 4,
                        "splitBy": "Result"
                      }
                    ],
                    "title": "Streaming Ingest Result",
                    "showOpenInMe": true,
                    "gridSettings": {
                      "rowLimit": 10000
                    },
                    "sortBy": [],
                    "showExportToExcel": true
                  },
                  "customWidth": "25",
                  "showPin": false,
                  "name": "Streaming Ingest Result"
                }
              ]
            },
            "name": "Streaming Ingestion",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "Cluster"
      },
      "name": "Cluster Group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "255d43af-8d9e-4b60-a8a1-335be810533f",
                  "version": "KqlParameterItem/1.0",
                  "name": "include_system_operations",
                  "label": "System operations",
                  "type": 2,
                  "description": "System operations (Data Management) are used for ingestion and other cluster management aspects",
                  "isRequired": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n{ \"value\": \"false\", \"label\": \"Do Not Include Data Management Operations\", \"selected\": \"true\" }, \r\n{ \"value\": \"true\", \"label\": \"Include Data Management Operations\", \"selected\": \"false\" }\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "above",
              "queryType": 0,
              "resourceType": "microsoft.kusto/clusters"
            },
            "conditionalVisibility": {
              "parameterName": "Usage",
              "comparison": "isNotEqualTo"
            },
            "name": "parameters - 7"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is KustoRunner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand \r\n| where TimeGenerated > datetime(2020-09-09T09:30:00Z) \r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak) \r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State, FailureReason, RootActivityId, User, ApplicationName, Principal, TotalCPU, MemoryPeak, CorrelationId, cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}'\r\n    //| where totimespan(TotalCPU) > totimespan(0)\r\n    | summarize TotalCPU=max(TotalCPU) \r\n  , MemoryPeak=max(MemoryPeak) by User, ApplicationName, CorrelationId \r\n;\r\nlet totalCPU = toscalar(dataset | summarize sum((totimespan(TotalCPU)/1s)));\r\nlet totalMemory = toscalar(dataset | summarize sum(MemoryPeak));\r\nlet topMemory = \r\n    dataset\r\n    | top-nested 10000 of User with others=\"Others\" by sum(MemoryPeak), top-nested 10000 of ApplicationName with others=\"Others\" by sum(MemoryPeak)\r\n    | extend PercentOfTotalClusterMemoryUsed = aggregated_ApplicationName/toreal(totalMemory)\r\n;\r\nlet topCpu = \r\n    dataset\r\n    | top-nested 10000 of User with others=\"Others\" by sum(totimespan(TotalCPU)/1s), top-nested 10000 of ApplicationName with others=\"Others\" by sum(totimespan(TotalCPU)/1s)\r\n    | extend PercentOfTotalClusterCpuUsed = aggregated_ApplicationName/toreal(totalCPU)\r\n;\r\ntopMemory\r\n| join kind = fullouter(topCpu) on User, ApplicationName\r\n| extend BothPercentages = PercentOfTotalClusterMemoryUsed+PercentOfTotalClusterCpuUsed\r\n| top 20 by BothPercentages desc\r\n| extend User = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", strcat(\"Kusto Data Management \",\"(\",User,\")\"),\r\nApplicationName==\"KustoQueryRunner\", strcat(\"Kusto Query Runner \",\"(\",User,\")\"),\r\nUser==\"AAD app id=e0331ea9-83fc-4409-a17d-6375364c3280\", \"DataMap Agent 001 (app id: e0331ea9-83fc-4409-a17d-6375364c3280)\", // Used for internal MS clusters \r\nUser)\r\n| where not (ApplicationName == \"Others\" and PercentOfTotalClusterMemoryUsed == 0 and PercentOfTotalClusterCpuUsed == 0)\r\n| project User, ApplicationName, PercentOfTotalClusterMemoryUsed * 100 , PercentOfTotalClusterCpuUsed * 100",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Top Resource Consumers",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Column1",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blue"
                          },
                          "numberFormat": {
                            "unit": 1,
                            "options": {
                              "style": "decimal",
                              "useGrouping": false
                            }
                          },
                          "tooltipFormat": {
                            "tooltip": "Percent Of Total Cluster Memory Used"
                          }
                        },
                        {
                          "columnMatch": "Column2",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blue"
                          },
                          "numberFormat": {
                            "unit": 1,
                            "options": {
                              "style": "decimal"
                            }
                          },
                          "tooltipFormat": {
                            "tooltip": "Percent Of Total Cluster CPU Used"
                          }
                        }
                      ],
                      "sortBy": [
                        {
                          "itemKey": "$gen_heatmap_Column1_2",
                          "sortOrder": 2
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "ApplicationName",
                          "label": "Application"
                        },
                        {
                          "columnId": "Column1",
                          "label": "% of Used Cluster Memory",
                          "comment": "Relative portion of the actual cluster memory consumption"
                        },
                        {
                          "columnId": "Column2",
                          "label": "% of Used Cluster CPU",
                          "comment": "Relative portion of the actual CPU consumption"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "$gen_heatmap_Column1_2",
                        "sortOrder": 2
                      }
                    ],
                    "chartSettings": {
                      "showLegend": true
                    }
                  },
                  "customWidth": "60",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Top Resource Consumers"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}'\r\n| where  CommandType != 'TableSetOrAppend'\r\n| summarize Count=count() by User, ApplicationName\r\n| project User, ApplicationName, Count\r\n| extend User = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", strcat(\"Kusto Data Management \",\"(\",User,\")\"),\r\nUser==\"AAD app id=e0331ea9-83fc-4409-a17d-6375364c3280\", \"DataMap Agent 001 (app id: e0331ea9-83fc-4409-a17d-6375364c3280)\", // Used for internal MS clusters\r\nUser)\r\n| order by Count desc\r\n//| top-nested 10 of User with others=\"Other Values\" by agg_User=sum(Count) desc;\r\n| top-nested 10 of User  by agg_User=sum(Count) desc, top-nested 5 of ApplicationName with others=\"Other applications\" by agg_App=sum(Count) desc\r\n|where not (ApplicationName == \"Other applications\" and agg_App == 0)\r\n|project-away agg_User;\r\ndataset\r\n",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Top Users and Applications by Command and Query Count (Nested)",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "agg_App",
                          "formatter": 4,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "agg_User",
                          "formatter": 4,
                          "formatOptions": {
                            "palette": "blue",
                            "compositeBarSettings": {
                              "labelText": "",
                              "columnSettings": []
                            }
                          }
                        }
                      ],
                      "sortBy": [
                        {
                          "itemKey": "$gen_bar_agg_App_2",
                          "sortOrder": 2
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "User"
                        },
                        {
                          "columnId": "ApplicationName",
                          "label": "Application"
                        },
                        {
                          "columnId": "agg_App",
                          "label": "Count"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "$gen_bar_agg_App_2",
                        "sortOrder": 2
                      }
                    ],
                    "chartSettings": {
                      "createOtherGroup": 11
                    }
                  },
                  "customWidth": "40",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Top Users by Command and Query Count - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is KustoRunner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| extend ApplicationName = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", \"Kusto Data Management\",\r\nApplicationName)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}'\r\n| where  CommandType != 'TableSetOrAppend'\r\n| summarize Count=count() by ApplicationName\r\n| project ApplicationName, Count\r\n| order by Count desc\r\n//| top-nested 10 of User with others=\"Other Values\" by agg_User=sum(Count) desc;\r\n| top-nested 10 of ApplicationName with others=\"Other Values\"  by agg_App=sum(Count) desc;\r\n//|where not (ApplicationName == \"Other applications\" and agg_App == 0)\r\n//|project-away agg_User;\r\ndataset\r\n",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Top Appplications by Command and Query Count",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "piechart",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "agg_App",
                          "formatter": 4,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "agg_User",
                          "formatter": 4,
                          "formatOptions": {
                            "palette": "blue",
                            "compositeBarSettings": {
                              "labelText": "",
                              "columnSettings": []
                            }
                          }
                        }
                      ],
                      "sortBy": [
                        {
                          "itemKey": "$gen_bar_agg_App_1",
                          "sortOrder": 2
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "ApplicationName",
                          "label": "Application"
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "$gen_bar_agg_App_1",
                        "sortOrder": 2
                      }
                    ],
                    "chartSettings": {
                      "createOtherGroup": 11
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Top Appplications by Command and Query Count"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is KustoRunner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}'\r\n| where  CommandType != 'TableSetOrAppend'\r\n| extend User = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", strcat(\"Kusto Data Management \",\"(\",User,\")\"),\r\nApplicationName==\"KustoQueryRunner\", strcat(\"Kusto Query Runner \",\"(\",User,\")\"),\r\nUser==\"AAD app id=e0331ea9-83fc-4409-a17d-6375364c3280\", \"DataMap Agent 001 (app id: e0331ea9-83fc-4409-a17d-6375364c3280)\", // Used for internal MS clusters \r\nUser)\r\n| summarize Count=count() by User\r\n| project User, Count\r\n| order by Count desc\r\n| top-nested 10 of User with others=\"Other Values\" by agg_User=sum(Count) desc;\r\ndataset\r\n",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Top Users by Command and Query Count",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "piechart",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "agg_User",
                          "formatter": 4,
                          "formatOptions": {
                            "palette": "blue",
                            "compositeBarSettings": {
                              "labelText": "",
                              "columnSettings": []
                            }
                          }
                        }
                      ],
                      "labelSettings": [
                        {
                          "columnId": "User"
                        },
                        {
                          "columnId": "agg_User",
                          "label": "Count (Commands & Queries)"
                        }
                      ]
                    },
                    "chartSettings": {
                      "createOtherGroup": 11
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Top Users by Command and Query Count"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is KustoRunner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}'\r\n| where  CommandType != 'TableSetOrAppend'\r\n| summarize Count=count() by CommandType\r\n| project CommandType, Count\r\n| order by Count desc\r\n| top-nested 9 of CommandType with others=\"Other Values\"  by agg_App=sum(Count) desc;\r\ndataset\r\n",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Top Commands by Command Types",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "piechart",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "agg_App",
                          "formatter": 4,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "agg_User",
                          "formatter": 4,
                          "formatOptions": {
                            "palette": "blue",
                            "compositeBarSettings": {
                              "labelText": "",
                              "columnSettings": []
                            }
                          }
                        }
                      ],
                      "sortBy": [
                        {
                          "itemKey": "$gen_bar_agg_App_1",
                          "sortOrder": 2
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "$gen_bar_agg_App_1",
                        "sortOrder": 2
                      }
                    ],
                    "chartSettings": {
                      "createOtherGroup": 11
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Top Commands by Command Types"
                }
              ]
            },
            "customWidth": "100",
            "name": "expander for commands",
            "styleSettings": {
              "padding": "10px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is KustoRunner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand\r\n| where TimeGenerated > ago(17d)\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n|extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where TimeGenerated > ago(17d)\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n| where cluster_name == '{Resource:name}';\r\nlet FullList = dataset | where CommandType != 'TableSetOrAppend';\r\n    let Last24Hours =\r\n        FullList\r\n        | where StartedOn >= ago(1d) and StartedOn < now()\r\n        | summarize Count=count() by User, ApplicationName\r\n        | top 100 by Count desc\r\n    ;\r\n    let HistoricalDailyAverage =\r\n        FullList\r\n        | where StartedOn >= ago(16d) and StartedOn < ago(1d)\r\n        | summarize Count=count()/15.0 by User, ApplicationName\r\n        | top 100 by Count desc\r\n    ;\r\n    let TimeRangeComparison =\r\n        Last24Hours\r\n        | join kind=leftouter (HistoricalDailyAverage) on User, ApplicationName\r\n        | project User=coalesce(User, User1), ApplicationName, Last24Hours=Count, HistoricalDailyAverage=round(Count1,0)\r\n        | extend PercentChange=round((Last24Hours-HistoricalDailyAverage)/toreal(HistoricalDailyAverage), 2)\r\n        | top 10 by Last24Hours desc\r\n    ;\r\n    TimeRangeComparison\r\n    | extend User = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", strcat(\"Kusto Data Management \",\"(\",User,\")\"),\r\n    ApplicationName==\"KustoQueryRunner\", strcat(\"Kusto Query Runner \",\"(\",User,\")\"),\r\n    User==\"AAD app id=e0331ea9-83fc-4409-a17d-6375364c3280\", \"DataMap Agent 001 (app id: e0331ea9-83fc-4409-a17d-6375364c3280)\", // Used for internal MS clusters \r\n    User)\r\n    | project User, ApplicationName, Last24Hours, HistoricalDailyAverage=round(HistoricalDailyAverage,0), PercentChange\r\n    | order by Last24Hours desc",
              "size": 3,
              "showAnalytics": true,
              "title": "Changes in Query Count by User (Not affected by the Time Rage)",
              "queryType": 0,
              "resourceType": "microsoft.kusto/clusters",
              "crossComponentResources": [
                "{Resource}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Last24Hours",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "blue"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "HistoricalDailyAverage",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "green"
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    },
                    "tooltipFormat": {
                      "tooltip": "StardedOn >= ago (16d) and StardedOn < ago(1d)"
                    }
                  },
                  {
                    "columnMatch": "PercentChange",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "<",
                          "thresholdValue": "0",
                          "representation": "trenddown",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": ">",
                          "thresholdValue": "0",
                          "representation": "trendup",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Infinity",
                          "representation": "Blank",
                          "text": "  ∞"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Blank",
                          "text": "{0}{1}"
                        }
                      ]
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "percent",
                        "useGrouping": false
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "ApplicationName",
                    "label": "Application"
                  },
                  {
                    "columnId": "Last24Hours",
                    "label": "Last 24 Hours"
                  },
                  {
                    "columnId": "HistoricalDailyAverage",
                    "label": "Historical Daily Average"
                  },
                  {
                    "columnId": "PercentChange",
                    "label": "% Change"
                  }
                ]
              },
              "chartSettings": {
                "showLegend": true
              }
            },
            "customWidth": "60",
            "conditionalVisibility": {
              "parameterName": "Usage",
              "comparison": "isNotEqualTo"
            },
            "name": "Changes in Query Count by User "
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Quert Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where LastUpdatedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}';\r\ndataset | where CommandType != 'TableSetOrAppend' and State == 'Failed'\r\n| summarize Count=count() by User, ApplicationName\r\n| top 10 by Count desc\r\n| extend User = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", strcat(\"Kusto Data Management \",\"(\",User,\")\"),\r\nApplicationName==\"KustoQueryRunner\", strcat(\"Kusto Query Runner \",\"(\",User,\")\"),\r\nUser==\"AAD app id=e0331ea9-83fc-4409-a17d-6375364c3280\", \"DataMap Agent 001 (app id: e0331ea9-83fc-4409-a17d-6375364c3280)\", // Used for internal MS clusters \r\nUser)\r\n| order by Count desc\r\n",
              "size": 3,
              "showAnalytics": true,
              "title": "Failed Queries Count",
              "noDataMessage": "🎉 No failed queries found",
              "noDataMessageStyle": 3,
              "timeContext": {
                "durationMs": 604800000
              },
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.kusto/clusters",
              "crossComponentResources": [
                "{Resource}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Count",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "red"
                    }
                  }
                ]
              },
              "chartSettings": {
                "showLegend": true
              }
            },
            "customWidth": "40",
            "conditionalVisibility": {
              "parameterName": "Usage",
              "comparison": "isNotEqualTo"
            },
            "name": "Failed Queries Count"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Count, Memory, and CPU By Users",
              "expandable": true,
              "expanded": true,
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}';\r\nlet FullList = dataset | where CommandType != 'TableSetOrAppend'\r\n    | project User, StartedOn , ApplicationName, CommandType\r\n;\r\nlet Top =\r\n    dataset\r\n    | summarize Count=count() by User\r\n    | top 10 by Count desc\r\n    | extend OriginalUser = User\r\n    | extend Category=User\r\n;\r\nFullList\r\n| join kind=leftouter(Top) on $left.User == $right.OriginalUser\r\n| project User=coalesce(Category, 'Other'), ApplicationName, CommandType, StartedOn\r\n| extend User = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", strcat(\"Kusto Data Management \",\"(\",User,\")\"),\r\nApplicationName==\"KustoQueryRunner\", strcat(\"Kusto Query Runner \",\"(\",User,\")\"),\r\nUser==\"AAD app id=e0331ea9-83fc-4409-a17d-6375364c3280\", \"DataMap Agent 001 (app id: e0331ea9-83fc-4409-a17d-6375364c3280)\", // Used for internal MS clusters \r\nUser)\r\n| summarize count() by User, bin(StartedOn, 1h)\r\n| summarize sum(count_) by bin(StartedOn, time(1h)),tostring(User) | sort by StartedOn asc",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Query Count by User",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "showLegend": true
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Query Count by User"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}';\r\nlet FullList = dataset | where CommandType != 'TableSetOrAppend'\r\n     | project User, ApplicationName, CommandType, StartedOn, MemoryPeak\r\n     | extend User = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", strcat(\"Kusto Data Management \",\"(\",User,\")\"),\r\nApplicationName==\"KustoQueryRunner\", strcat(\"Kusto Query Runner \",\"(\",User,\")\"),\r\nUser==\"AAD app id=e0331ea9-83fc-4409-a17d-6375364c3280\", \"DataMap Agent 001 (app id: e0331ea9-83fc-4409-a17d-6375364c3280)\", // Used for internal MS clusters \r\nUser)\r\n;\r\nlet Top =\r\n    FullList\r\n    | summarize Memory=sum(MemoryPeak) by User\r\n    | top 10 by Memory desc\r\n    | extend OriginalUser = User\r\n    | project OriginalUser, Category=User\r\n;\r\nFullList\r\n| join kind=leftouter(Top) on $left.User == $right.OriginalUser\r\n| project User=coalesce(Category, 'Other'), StartedOn, MemoryPeakGB=MemoryPeak/1024.0/1024.0/1024.0\r\n| summarize MemoryPeakGB=sum(MemoryPeakGB) by User, bin(StartedOn, 1h)\r\n| summarize sum(MemoryPeakGB) by bin(StartedOn, time(1h)),tostring(User) | sort by StartedOn asc",
                    "size": 0,
                    "aggregation": 3,
                    "showAnalytics": true,
                    "title": "Total Memory by User",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 5,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Total Memory by User"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where StartedOn {TimeRange}\r\n    | where cluster_name == '{Resource:name}';\r\nlet FullList = dataset | where CommandType != 'TableSetOrAppend'\r\n      | project User, ApplicationName, CommandType, StartedOn, TotalCPU\r\n      | extend User = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", strcat(\"Kusto Data Management \",\"(\",User,\")\"),\r\n    ApplicationName==\"KustoQueryRunner\", strcat(\"Kusto Query Runner \",\"(\",User,\")\"),\r\n    User==\"AAD app id=e0331ea9-83fc-4409-a17d-6375364c3280\", \"DataMap Agent 001 (app id: e0331ea9-83fc-4409-a17d-6375364c3280)\", // Used for internal MS clusters \r\n    User)\r\n;\r\nlet Top =\r\n    FullList\r\n    | summarize TotalCpu=sum(totimespan(TotalCPU)) by User\r\n    | top 10 by TotalCpu desc\r\n    | extend OriginalUser = User\r\n    | project OriginalUser, Category=User\r\n;\r\nFullList\r\n| join kind=leftouter(Top) on $left.User == $right.OriginalUser\r\n| project User=coalesce(Category, 'Other'), StartedOn, TotalCpuMinutes=totimespan(TotalCPU)/1m\r\n| summarize TotalCpuMinutes=sum(TotalCpuMinutes) by User, bin(StartedOn, 1h)\r\n| top-nested  of bin(StartedOn, time(1h)) by sum(TotalCpuMinutes),top-nested 5 of User with others=\"Other Values\" by sum_TotalCpuMinutes=sum(TotalCpuMinutes) desc | sort by StartedOn asc | project StartedOn,User,sum_TotalCpuMinutes\r\n",
                    "size": 0,
                    "aggregation": 3,
                    "showAnalytics": true,
                    "title": "Total CPU by User",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 25,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Total CPU by User"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "Usage",
              "comparison": "isNotEqualTo"
            },
            "name": "By Users",
            "styleSettings": {
              "margin": "5px 0px 0px 0px"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Count, Memory, and CPU By Application",
              "expandable": true,
              "expanded": true,
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| extend ApplicationName = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", \"Kusto Data Management\", ApplicationName)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}';\r\nlet FullList = dataset | where CommandType != 'TableSetOrAppend'\r\n   | project ApplicationName, StartedOn, CommandType, User\r\n;\r\nlet Top =\r\n    FullList\r\n    | summarize Count=count() by ApplicationName\r\n    | top 10 by Count desc\r\n    | extend Category=ApplicationName\r\n;\r\nFullList\r\n| join kind=leftouter(Top) on ApplicationName \r\n| project Application=coalesce(Category, '-'), CommandType, User, StartedOn\r\n| summarize count() by Application, bin(StartedOn, 1h)\r\n| summarize sum(count_) by bin(StartedOn, time(1h)),tostring(Application) | sort by StartedOn asc\r\n  ",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Query Count by Application",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "showLegend": true
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Query Count by Application"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak) \r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| extend ApplicationName = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", \"Kusto Data Management\", ApplicationName)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}';\r\nlet FullList = dataset | where CommandType != 'TableSetOrAppend'\r\n   | project ApplicationName, StartedOn, CommandType, User, MemoryPeak\r\n;\r\nlet Top =\r\n    FullList\r\n   | summarize Memory=sum(MemoryPeak) by ApplicationName\r\n    | top 10 by Memory desc\r\n    | extend Category=ApplicationName;\r\nFullList\r\n| join kind=inner(Top) on ApplicationName\r\n| project Application=coalesce(Category, '-'), CommandType, User, StartedOn, MemoryPeakMB=MemoryPeak/1024.0/1024.0\r\n| summarize MemoryPeakMB=sum(MemoryPeakMB) by Application, bin(StartedOn, 1h)\r\n| summarize sum(MemoryPeakMB) by bin(StartedOn, time(1h)),tostring(Application) | sort by StartedOn asc\r\n  ",
                    "size": 0,
                    "aggregation": 3,
                    "showAnalytics": true,
                    "title": "Total Memory by Application",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 4,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Total Memory by Application"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| extend ApplicationName = case(ApplicationName==\"Kusto.WinSvc.DM.Svc\", \"Kusto Data Management\", ApplicationName)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}';\r\nlet FullList = dataset | where CommandType != 'TableSetOrAppend'\r\n   | project ApplicationName, CommandType, User, StartedOn, TotalCPU\r\n;\r\nlet Top =\r\n    FullList\r\n    | summarize TotalCPU=sum(totimespan(TotalCPU)) by ApplicationName\r\n    | top 10 by TotalCPU desc\r\n    | extend Category=ApplicationName\r\n;\r\nFullList\r\n| join kind=inner(Top) on ApplicationName\r\n| project Application=coalesce(Category, '-'), CommandType, User, StartedOn, TotalCpuMinutes=totimespan(TotalCPU)/1m\r\n| summarize TotalCpuMinutes=sum(TotalCpuMinutes) by Application, bin(StartedOn, 1h)\r\n| summarize sum(TotalCpuMinutes) by bin(StartedOn, time(1h)),tostring(Application) | sort by StartedOn asc\r\n  ",
                    "size": 0,
                    "aggregation": 3,
                    "showAnalytics": true,
                    "title": "Total CPU by Application",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 25,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Total CPU by Application"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "Usage",
              "comparison": "isNotEqualTo"
            },
            "name": "By Application"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Count, Memory, and CPU By Type",
              "expandable": true,
              "expanded": true,
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak)\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}';\r\ndataset | where CommandType != 'TableSetOrAppend' \r\n| top-nested  of bin(StartedOn, time(1h)) by count(),top-nested 5 of CommandType by count_=count() desc | sort by StartedOn asc | project StartedOn,CommandType,count_\r\n",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Query and Command Count by Type",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "showLegend": true
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Query and Commans Count by Type"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak) \r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n| where cluster_name == '{Resource:name}';\r\ndataset | where CommandType != 'TableSetOrAppend' \r\n| extend MemoryPeakGB=MemoryPeak/1024.0/1024.0/1024.0\r\n| top-nested  of bin(StartedOn, time(1h)) by sum(MemoryPeakGB),top-nested 5 of CommandType with others=\"Other Values\" by sum_MemoryPeakGB=sum(MemoryPeakGB) desc | sort by StartedOn asc | project StartedOn,CommandType,sum_MemoryPeakGB\r\n",
                    "size": 0,
                    "aggregation": 3,
                    "showAnalytics": true,
                    "title": "Total Memory by Type",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 5,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Total Memory by Type"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let system_databases = dynamic(['KustoMonitoringPersistentDatabase', '$systemdb']); \r\nlet system_users = dynamic(['AAD app id=b753584e-c468-4503-852a-374280ce7a62', 'KustoServiceBuiltInPrincipal']); // b753584e-c468-4503-852a-374280ce7a62 is Kusto Query Runner\r\nlet system_cluster_management_applications = dynamic(['Kusto.WinSvc.CM.Svc']); // Kusto Cluster Management\r\nlet CommandTable = ADXCommand | extend MemoryPeak = tolong(ResourceUtilization.MemoryPeak) \r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| project-away ResourceUtilization;\r\nlet QueryTable = ADXQuery\r\n| where StartedOn {TimeRange}\r\n| where DatabaseName  !in (system_databases) and User !in (system_users) and ApplicationName !in (system_cluster_management_applications)\r\n| where (({include_system_operations} == \"false\" and ApplicationName != 'Kusto.WinSvc.DM.Svc') or {include_system_operations} == \"true\")\r\n| extend MemoryPeak = tolong(MemoryPeak)\r\n| parse _ResourceId with * \"providers/microsoft.kusto/clusters/\" cluster_name\r\n| extend CommandType = 'Query';\r\nlet dataset_commands_queries = CommandTable | union (QueryTable)\r\n| project CommandType, DatabaseName, StartedOn, LastUpdatedOn, Duration, State,\r\nFailureReason, RootActivityId, User, ApplicationName, Principal,TotalCPU,MemoryPeak,CorrelationId,cluster_name;\r\nlet dataset = dataset_commands_queries\r\n    | where cluster_name == '{Resource:name}';\r\ndataset | where CommandType != 'TableSetOrAppend' \r\n| extend TotalCpuMinutes = totimespan(TotalCPU)/1m\r\n| top-nested  of bin(StartedOn, time(1h)) by sum(TotalCpuMinutes),top-nested 5 of CommandType with others=\"Other Values\" by sum_TotalCpuMinutes=sum(TotalCpuMinutes) desc | sort by StartedOn asc | project StartedOn,CommandType,sum_TotalCpuMinutes\r\n",
                    "size": 0,
                    "aggregation": 3,
                    "showAnalytics": true,
                    "title": "Total CPU by Type",
                    "timeContext": {
                      "durationMs": 604800000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.kusto/clusters",
                    "crossComponentResources": [
                      "{Resource}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 25,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "33",
                  "conditionalVisibility": {
                    "parameterName": "Usage",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "Total CPU by Type"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "Usage",
              "comparison": "isNotEqualTo"
            },
            "name": "By Type"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "Additional monitoring coverage is based on platform logs (diagnostic logs).</br>Either you have not enabled the logs or there is no log data for this resource in the Log Analytics workapsce. [Learn more](https://docs.microsoft.com/en-us/azure/data-explorer/using-diagnostic-logs?tabs=commands-and-queries#set-up-diagnostic-logs-for-an-azure-data-explorer-cluster)",
                    "style": "upsell"
                  },
                  "customWidth": "60",
                  "name": "text - 2"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "cellValue": "{Resource}",
                        "linkTarget": "Resource",
                        "linkLabel": "Enable Logs for Monitoring",
                        "subTarget": "diagnostics",
                        "style": "primary"
                      }
                    ]
                  },
                  "customWidth": "60",
                  "name": "links - 8"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "Usage",
              "comparison": "isEqualTo"
            },
            "name": "Onboarding Message - Commands"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "Commands"
      },
      "name": "Commands"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
