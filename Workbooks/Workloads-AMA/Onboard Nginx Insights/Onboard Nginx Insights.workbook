{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "0d87fd70-3f59-4824-b3ac-9867394090a5",
            "version": "KqlParameterItem/1.0",
            "name": "VirtualMachine",
            "type": 5,
            "isRequired": true,
            "value": "value::1",
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.compute/virtualmachines": true
              },
              "additionalResourceOptions": [
                "value::1"
              ]
            }
          },
          {
            "id": "7b1d0a3f-4341-47a5-9f2c-990d5b1faaab",
            "version": "KqlParameterItem/1.0",
            "name": "VmName",
            "type": 1,
            "isRequired": true,
            "query": "Resources\r\n| where id =~ '{VirtualMachine}'\r\n| project name",
            "crossComponentResources": [
              "value::all"
            ],
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "504c4e1f-42e8-4628-adfe-17fa76991377",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "type": 1,
            "isRequired": true,
            "query": "Resources\r\n| where id =~ '{VirtualMachine}'\r\n| project rg = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "b1e02c76-ad55-4534-82fc-d8068f273569",
            "version": "KqlParameterItem/1.0",
            "name": "DcrName",
            "type": 1,
            "query": "Resources\r\n| where id == '{VirtualMachine}'\r\n| project Value = strcat(name, '-telegraf-dcr')",
            "crossComponentResources": [],
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "fca13895-5385-439c-ae31-8955f19e916a",
            "version": "KqlParameterItem/1.0",
            "name": "WorkloadTag",
            "type": 1,
            "value": "telegraf"
          }
        ],
        "style": "above",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": {
        "parameterName": "1",
        "comparison": "isEqualTo",
        "value": "2"
      },
      "name": "armparameters"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Azure Monitor for NGINX"
            },
            "name": "infoText"
          },
          {
            "type": 1,
            "content": {
              "json": "![Nginx logo](https://raw.githubusercontent.com/acearun/managedsolutions/master/Templates/Logos/nginx-logo.jpg)\r\n"
            },
            "name": "nginxlogo",
            "styleSettings": {
              "margin": "20px 0 0 20px"
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "links": [
                {
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Overview",
                  "subTarget": "Overview",
                  "style": "link"
                },
                {
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Prerequisites",
                  "subTarget": "Prerequisites",
                  "style": "link"
                },
                {
                  "cellValue": "selectedTab",
                  "linkTarget": "parameter",
                  "linkLabel": "Configure monitoring",
                  "subTarget": "Configure",
                  "style": "link"
                }
              ]
            },
            "name": "tabs",
            "styleSettings": {
              "margin": "15px 0 0 0"
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "Telegraf is a plugin-driven server agent for collecting and sending metrics and events from databases, systems, and IoT sensors.\n\nAzure Monitor enables you to easily setup and deploy Telegraf data collection on Azure virtual machines. Just provide your Telegraf configuration in the `Enable monitoring` tab and you are good to go. All data will go to the `InsighsMetrics` table in the Log Analytics Workspace configured with your virtuals machine.\n\n"
                  },
                  "name": "NginxInformation"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "Overview"
            },
            "name": "Overview group"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "NGINX needs to be configured with http_stub_status_module to enable collection of usage metrics. This can be done by enabling sub_status in the local config file (e.g. `/etc/nginx/conf.d/status.conf`)\n```\nserver { \n    \n    listen 127.0.0.1:9090;\n    location /nginx_status {\n        stub_status on;\n\n        access_log off;\n        allow 127.0.0.1;\n        deny all;\n    }\n}\n```\n\n"
                  },
                  "name": "NginxInformation"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "Prerequisites"
            },
            "name": "Prerequisite group"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "#### Step 1 - choose a destination Log Analytics workspace"
                  },
                  "name": "text - 4",
                  "styleSettings": {
                    "margin": "15px 0 5px 0"
                  }
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "crossComponentResources": [
                      "{WorkspaceSubscription}"
                    ],
                    "parameters": [
                      {
                        "id": "597de314-c241-4af8-9a9d-784389b4cf5a",
                        "version": "KqlParameterItem/1.0",
                        "name": "WorkspaceSubscription",
                        "label": "Subscription",
                        "type": 6,
                        "isRequired": true,
                        "value": null,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "includeAll": true
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "ad94aaae-a223-4ba6-911e-af304e054c08",
                        "version": "KqlParameterItem/1.0",
                        "name": "Workspace",
                        "type": 5,
                        "isRequired": true,
                        "query": "Resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces' and location == 'eastus'\r\n| project value = id, label = id, selected = false, group = resourceGroup",
                        "crossComponentResources": [
                          "{WorkspaceSubscription}"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": []
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                      },
                      {
                        "id": "62f4cd2e-72a0-456f-bb20-e23026b77135",
                        "version": "KqlParameterItem/1.0",
                        "name": "WorkspaceId",
                        "type": 1,
                        "isRequired": true,
                        "query": "Resources\r\n| where id == '{Workspace}'\r\n| project value = properties.customerId",
                        "crossComponentResources": [
                          "{WorkspaceSubscription}"
                        ],
                        "isHiddenWhenLocked": true,
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources"
                      }
                    ],
                    "style": "above",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources"
                  },
                  "name": "parameters - 2"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "#### Step 2 - configure NGINX data collection"
                  },
                  "name": "text - 3",
                  "styleSettings": {
                    "margin": "15px 0 5px 0"
                  }
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "0fcd1a59-1ca7-4e29-a0c7-6eb5b032ef6a",
                        "version": "KqlParameterItem/1.0",
                        "name": "TelegrafConfig",
                        "label": "NGINX Telegraf config",
                        "type": 1,
                        "isRequired": true,
                        "value": "[inputs.nginx]\r\n   urls = [\"http://127.0.0.1:9090/nginx_status\"] \r\n   response_timeout = '5s'\r\n\r\n   [inputs.nginx.tags]\r\n   insight = 'nginx'\r\n\r\n[inputs.cpu]\r\n   percpu = true\r\n   totalcpu = true\r\n   collect_cpu_time = false\r\n   report_active = false\r\n\t\r\n   [inputs.cpu.tags]\r\n   insight = 'nginx'\r\n\r\n[inputs.mem.tags]\r\n   insight = 'nginx'\r\n\r\n[inputs.netstat.tags]\r\n   insight = 'nginx'\r\n\r\n[inputs.net.tags]\r\n   insight = 'nginx'\r\n\r\n[inputs.procstat]\r\n   pid_file = '/var/run/nginx.pid'\r\n\r\n[inputs.procstat.tags]\r\n   insight = 'nginx'",
                        "typeSettings": {
                          "multiLineText": true,
                          "editorLanguage": "text",
                          "multiLineHeight": 12
                        }
                      }
                    ],
                    "style": "formVertical",
                    "queryType": 0
                  },
                  "name": "telegrafconfigfield"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "cellValue": "f",
                        "linkTarget": "ArmTemplate",
                        "linkLabel": "Enable Telegraf monitoring",
                        "style": "primary",
                        "linkIsContextBlade": true,
                        "templateRunContext": {
                          "componentIdSource": "parameter",
                          "componentId": "ResourceGroup",
                          "templateUriSource": "static",
                          "templateUri": "https://raw.githubusercontent.com/acearun/managedsolutions/master/Templates-Dcr/Telegraf/azuredeploy.json",
                          "templateParameters": [
                            {
                              "name": "insight",
                              "source": "parameter",
                              "value": "WorkloadTag",
                              "kind": "value"
                            },
                            {
                              "name": "destinationName",
                              "source": "static",
                              "value": "TelegrafDestination",
                              "kind": "value"
                            },
                            {
                              "name": "dataSource",
                              "source": "static",
                              "value": "TelegrafDataSource",
                              "kind": "value"
                            },
                            {
                              "name": "stream",
                              "source": "static",
                              "value": "Microsoft-InsightsMetrics",
                              "kind": "value"
                            },
                            {
                              "name": "workspaceResourceId",
                              "source": "parameter",
                              "value": "Workspace",
                              "kind": "value"
                            },
                            {
                              "name": "workspaceId",
                              "source": "parameter",
                              "value": "WorkspaceId",
                              "kind": "value"
                            },
                            {
                              "name": "serializedTelegrafConfig",
                              "source": "parameter",
                              "value": "TelegrafConfig",
                              "kind": "value"
                            },
                            {
                              "name": "vmName",
                              "source": "parameter",
                              "value": "VmName",
                              "kind": "value"
                            },
                            {
                              "name": "associationName",
                              "source": "static",
                              "value": "TelegrafAssociation",
                              "kind": "value"
                            }
                          ],
                          "titleSource": "static",
                          "title": "Enable Telegraf data collection",
                          "descriptionSource": "static",
                          "description": "![Telegraf logo](https://raw.githubusercontent.com/acearun/managedsolutions/master/Templates/Logos/telegraf-logo.png)\r\n\r\n<br/>\r\n<br/>\r\nWe're ready to deploy Telegraf data collection to your virtual machine! Choose **Enable monitoring** to start monitoring.\r\n",
                          "runLabelSource": "static",
                          "runLabel": "Enable monitoring"
                        }
                      }
                    ]
                  },
                  "conditionalVisibilities": [
                    {
                      "parameterName": "TelegrafConfig",
                      "comparison": "isNotEqualTo"
                    },
                    {
                      "parameterName": "VirtualMachine",
                      "comparison": "isNotEqualTo"
                    },
                    {
                      "parameterName": "Workspace",
                      "comparison": "isNotEqualTo"
                    },
                    {
                      "parameterName": "VmName",
                      "comparison": "isNotEqualTo"
                    },
                    {
                      "parameterName": "ResourceGroup",
                      "comparison": "isNotEqualTo"
                    }
                  ],
                  "name": "enablenginxmonitoringlink",
                  "styleSettings": {
                    "margin": "20px 0 0 0"
                  }
                },
                {
                  "type": 1,
                  "content": {
                    "json": "Specify stub_status URI matching this form: \r\n\r\n```\r\n[http://]@address[:port]/nginx_status\r\n```\r\nFor instance,\r\n```\r\nhttp://127.0.0.1:9090/nginx_status\r\n```"
                  },
                  "name": "text - 6"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "selectedTab",
              "comparison": "isEqualTo",
              "value": "Configure"
            },
            "name": "Configure group"
          }
        ]
      },
      "name": "Overview group"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}