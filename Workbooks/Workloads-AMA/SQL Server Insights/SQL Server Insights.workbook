{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{MonitoringProfileSub}"
        ],
        "parameters": [
          {
            "id": "af2af70b-7ea5-40a0-be60-2d87c0d17ed8",
            "version": "KqlParameterItem/1.0",
            "name": "MonitoringProfileSub",
            "label": "Subscription",
            "type": 6,
            "isRequired": true,
            "query": "Resources\n| summarize Count = countif(type =~ 'Microsoft.Insights/dataCollectionRules' and tags contains 'SqlInsights') by subscriptionId\n| order by Count desc\n| extend Row = row_number()\n| project value = subscriptionId, label = subscriptionId, selected = Row == 1",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "af2af70b-7ea5-40a0-be60-2d87c0d17ed8",
            "version": "KqlParameterItem/1.0",
            "name": "MonitoringProfile",
            "label": "Monitoring profile",
            "type": 5,
            "isRequired": true,
            "query": "Resources\n| where type =~ 'Microsoft.Insights/dataCollectionRules' and tags contains 'SqlInsights'\n| order by resourceGroup asc, tolower(name) asc\n| extend Row = row_number()\n//| project value = id, label = id, selected = Row == 1, group = resourceGroup",
            "crossComponentResources": [
              "{MonitoringProfileSub}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": null
          },
          {
            "id": "0cebb139-7c97-434a-b077-07704c77c295",
            "version": "KqlParameterItem/1.0",
            "name": "Associations",
            "type": 2,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{MonitoringProfile}/associations?api-version=2019-11-01-preview\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"id\",\"columnid\":\"Id\"}]}}]}",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "defaultValue": "value::all",
            "queryType": 12,
            "value": [
              "value::all"
            ]
          },
          {
            "id": "0a9b1be7-5981-4d35-9b5e-fd7c7f9e80ef",
            "version": "KqlParameterItem/1.0",
            "name": "Workspaces",
            "type": 5,
            "isRequired": true,
            "query": "Resources\n| where id =~ '{MonitoringProfile}'\n| project la = properties.destinations.logAnalytics\n| mvexpand la limit 400\n| project id = tostring (la.workspaceResourceId)\n| project value = id, label = id, selected = true",
            "crossComponentResources": [
              "{MonitoringProfileSub}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": null
          },
          {
            "id": "0b697882-249b-4053-9807-9e654383d2a5",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 14400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                }
              ]
            }
          },
          {
            "id": "c7688036-0080-4174-94ae-51b64b5211d9",
            "version": "KqlParameterItem/1.0",
            "name": "OnboardedComputers",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "Resources\r\n| take 1\r\n| project associations = dynamic([{Associations}])\r\n| mvexpand associations limit 400\r\n| project id = tolower(extract(@'(?i)/subscriptions/.+/resourcegroups/.+/providers/microsoft.compute/virtualmachines/(.+)/providers/microsoft.insights/datacollectionruleassociations/.+', 1, tostring(associations)))\r\n| project value = id, label = id, selected = true\r\n\r\n",
            "crossComponentResources": [
              "{MonitoringProfileSub}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "4cc2a2af-8213-45d4-84bd-0728a196fdee",
            "version": "KqlParameterItem/1.0",
            "name": "CommonErrors",
            "type": 1,
            "isRequired": true,
            "value": "[\n  {\n    \"key\": \"login error\",\n    \"action\": \"SQL login error\",\n    \"description\": \"The SQL login credentials used by your monitoring VM appears to be incorrect. Please refer to [our documentation](https://aka.ms/sqlinsights/ui/links/setup) for creating the telegraf user, the permissions it needs, and setting the configuration on your monitoring VM. If using a Key Vault to store the password as a secret, please confirm it is using the correct value.\"\n  },\n  {\n    \"key\": \"Unable to open tcp connection with host\",\n    \"action\": \"Connection error\",\n    \"description\": \"Your monitoring VM does not appear to have access to the following SQL resource. Please refer to [our documentation](https://aka.ms/sqlinsights/ui/links/setup) for enabling network access for your monitoring VM to access your SQL resource.\"\n  },\n  {\n    \"key\": \"does not have secrets get permission on key vault\",\n    \"action\": \"Key Vault permission error\",\n    \"description\": \"The monitoring VM does not have get permission on the Key vault secret provided in your monitoring profile. To correct this, trigger 'Configure' for the monitoring VM, specifying the Key Vault resources needed. Please refer to [our documentation](https://go.microsoft.com/fwlink/?linkid=2125287) for more details.\"\n  },\n  {\n    \"key\": \"SecretNotFound\",\n    \"action\": \"Key Vault secret error\",\n    \"description\": \"The name of the Key Vault secret provided in your monitoring profile appears to be incorrect. Please refer to [our documentation](https://aka.ms/sqlinsights/ui/links/setup) for providing the Key Vault secret name and setting the configuration on your monitoring VM.\"\n  },\n  {\n    \"key\": \"disabled secret\",\n    \"action\": \"Key Vault disabled secret error\",\n    \"description\": \"The Key vault secret your are trying to access has been disabled.  To correct this, you can either re-enable the secret from your Key Vault or create a new one. If you create a new secret, you will need to update your monitoring profile to reference it. Please refer to [our documentation](https://aka.ms/sqlinsights/ui/links/setup) for more details.\"\n  },\n  {\n    \"key\": \"user does not have permission\",\n    \"action\": \"User does not have permission\",\n    \"description\": \"The user does not have permission to view the database state. To correct this, you need to grant VIEW DATABASE STATE permissions by running <code>GRANT VIEW DATABASE STATE TO [<username>];<//code>. Please refer to [our documentation](https://aka.ms/sqlinsights/ui/links/setup) for more details.\"\n  },\n  {\n    \"key\": \"is not allowed to access the server\",\n    \"action\": \"Firewall is blocking access\",\n    \"description\": \"The SQL DB firewall is blocking access to the server.  To correct this, use the Windows Azure Management Portal or run sp_set_firewall_rule on the master database to create a firewall rule for this IP address or address range. It may take up to five minutes for this change to take effect. Please refer to [our documentation](https://docs.microsoft.com/en-us/azure/azure-sql/database/firewall-configure) for more details.\"\n  },\n  {\n    \"key\": \"The server was not found or was not accessible\",\n    \"action\": \"Client machine is not in Virtual Network\",\n    \"description\": \"The server was not found or was not accessible. It is possible that the client machine is not in the Virtual network. Please refer to [our documentation](https://aka.ms/sqlinsights/ui/links/setup) for more details.\"\n  }\n]",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "multiLineText": true,
              "editorLanguage": "json",
              "multiLineHeight": 10
            }
          },
          {
            "id": "26db4e3e-bd1c-4242-8a88-52550bf4e2f5",
            "version": "KqlParameterItem/1.0",
            "name": "AlertTemplates",
            "type": 1,
            "value": "[\r\n    {\r\n        \"name\": \"Azure DB and Azure MI CPU utilization percent\",\r\n        \"description\": \"Fired when Azure DB or Azure MI CPU utilization percentage from your service tier exceeds the specified threshold. Looks at the 95th percentile value over 5 minutes, and if it exceeds the threshold over 3 consecutive time periods the alert is triggered. For more details on this metric, refer to [this document](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database?view=azuresqldb-current).\",\r\n        \"author\": \"Microsoft\",\r\n        \"uniqueTag\": \"sql-db-mi-cpu-utilization-percent\",\r\n        \"recommendationLevel\": 2,\r\n\t\t\"severity\": \"2\",\r\n        \"applyTo\": [],\r\n        \"alertTemplate\": {\r\n            \"type\": \"log-metric-measurement\",\r\n            \"query\": \"InsightsMetrics | where Namespace == 'sqlserver_azure_db_resource_stats' and Name == 'avg_cpu_percent' | extend Tags = todynamic(Tags) | where tostring(Tags.['azm.ms/profileid']) == '{ProfileId}' | extend Instance = Tags.sql_instance, Database = Tags.database_name | summarize AggregatedValue = percentile(Val,95) by bin(TimeGenerated, 5m), tostring(Instance), tostring(Database)\",\r\n            \"thresholdOperator\": \"GreaterThan\",\r\n            \"defaultThreshold\": \"90\",\r\n            \"metricMeasurement\": {\r\n                \"thresholdOperator\": \"GreaterThan\",\r\n                \"threshold\": \"3\",\r\n                \"metricTriggerType\": \"Consecutive\",\r\n                \"metricColumn\": \"Instance\"\r\n            }\r\n        }\r\n    }\r\n]\r\n",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "multiLineText": true,
              "editorLanguage": "json"
            }
          },
          {
            "id": "5ab26f46-621e-490a-bab3-fbd51ed11e0d",
            "version": "KqlParameterItem/1.0",
            "name": "AlertCount",
            "type": 1,
            "isRequired": true,
            "query": "AlertsManagementResources\r\n| where type =~ 'microsoft.alertsmanagement/alerts'\r\n| where properties.essentials.startDateTime {TimeRange}\r\n| where subscriptionId == '{Workspaces:subscription}'\r\n| extend AlertRule=tolower(tostring(properties.essentials.alertRule))\r\n| join kind=inner (Resources | where type =~ 'microsoft.insights/scheduledQueryRules'\r\n| extend profileId=tolower(tags.['profile-id'])\r\n| where profileId == tolower('{MonitoringProfile}')\r\n| project AlertRule=tolower(id)) on AlertRule\r\n| summarize Count=tostring(count())",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "customWidth": "0",
      "name": "parameters - 0",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "nav",
        "links": [
          {
            "id": "62fd90c2-98a3-4668-9527-95c62d908d9a",
            "linkTarget": "WorkbookTemplate",
            "linkLabel": "Create new profile",
            "style": "primary",
            "linkIsContextBlade": true,
            "workbookContext": {
              "componentIdSource": "workbook",
              "resourceIdsSource": "workbook",
              "templateIdSource": "static",
              "templateId": "Community-Workbooks/Workloads-AMA/Create new profile",
              "typeSource": "static",
              "type": "workload-onboarding",
              "gallerySource": "static",
              "gallery": "Azure Monitor",
              "locationSource": "default"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MonitoringProfile",
        "comparison": "isEqualTo"
      },
      "customWidth": "0",
      "name": "Primary Create new profile",
      "styleSettings": {
        "margin": "35px 0 0 -5px"
      }
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "nav",
        "links": [
          {
            "id": "86f5a193-5333-4ee4-bab3-bc7d2072774a",
            "linkTarget": "WorkbookTemplate",
            "linkLabel": "Alerts ({AlertCount})",
            "style": "primary",
            "linkIsContextBlade": true,
            "workbookContext": {
              "componentIdSource": "workbook",
              "resourceIdsSource": "workbook",
              "templateIdSource": "static",
              "templateId": "Community-Workbooks/Workloads-AMA/Alerts",
              "typeSource": "static",
              "type": "workload-onboarding",
              "gallerySource": "static",
              "gallery": "Azure Monitor",
              "locationSource": "default",
              "passSpecificParams": true,
              "templateParameters": [
                {
                  "name": "MonitoringProfile",
                  "source": "parameter",
                  "value": "MonitoringProfile"
                },
                {
                  "name": "TimeRange",
                  "source": "parameter",
                  "value": "TimeRange"
                },
                {
                  "name": "AlertTemplates",
                  "source": "parameter",
                  "value": "AlertTemplates"
                }
              ]
            }
          },
          {
            "id": "8a20242a-c536-4b22-a012-10128ad5fa92",
            "linkTarget": "WorkbookTemplate",
            "linkLabel": "Create new profile",
            "style": "secondary",
            "linkIsContextBlade": true,
            "workbookContext": {
              "componentIdSource": "workbook",
              "resourceIdsSource": "workbook",
              "templateIdSource": "static",
              "templateId": "Community-Workbooks/Workloads-AMA/Create new profile",
              "typeSource": "static",
              "type": "workload-onboarding",
              "gallerySource": "static",
              "gallery": "Azure Monitor",
              "locationSource": "default"
            }
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "MonitoringProfile",
          "comparison": "isNotEqualTo"
        },
        {
          "parameterName": "AlertCount",
          "comparison": "isNotEqualTo"
        }
      ],
      "customWidth": "0",
      "name": "Secondary Create new profile",
      "styleSettings": {
        "margin": "35px 0 0 -5px"
      }
    },
    {
      "type": 1,
      "content": {
        "json": "Please select an existing SQL monitoring profile or create a new one using the `Create new profile` button.",
        "style": "warning"
      },
      "conditionalVisibility": {
        "parameterName": "MonitoringProfile",
        "comparison": "isEqualTo"
      },
      "name": "Select or create new profile message",
      "styleSettings": {
        "margin": "20px 0 0 0"
      }
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "37f0d44c-c4f4-44e6-ad23-63ddfdfe6386",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Overview",
            "subTarget": "Overview",
            "style": "link"
          },
          {
            "id": "65469e9c-6f35-4325-bb27-0a80e061d1af",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Manage profile",
            "subTarget": "Manage profile",
            "style": "link"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MonitoringProfile",
        "comparison": "isNotEqualTo"
      },
      "name": "links - 3",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "Looks like you don't have any monitoring virtual machines associated with this profile. Please associate one or more from the `Manage profile` tab.",
                    "style": "warning"
                  },
                  "conditionalVisibilities": [
                    {
                      "parameterName": "MonitoringProfile",
                      "comparison": "isNotEqualTo"
                    },
                    {
                      "parameterName": "OnboardedComputers",
                      "comparison": "isEqualTo"
                    }
                  ],
                  "name": "text - 0 - Copy",
                  "styleSettings": {
                    "margin": "20px 0 0 0"
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "OnboardedComputers",
              "comparison": "isEqualTo",
              "value": ""
            },
            "name": "Onboarding message"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let dbsInGroup = datatable(Type:string)[\r\n  \"Azure SQL Databases\"\r\n];\r\nlet data = InsightsMetrics\r\n| where Computer in~ ({OnboardedComputers})\r\n| where Namespace contains 'sqlserver_server_properties' and Name in~ ('uptime', 'engine_edition')\r\n| extend Tags = todynamic(Tags)\r\n| extend Database = tostring(Tags.database_name), Instance = tostring(Tags.sql_instance)\r\n| extend DatabaseKey = iff(Database == Instance, Database, strcat(Database, ' on ', Instance));\r\ndata\r\n| summarize (LastTimestamp, Val) = arg_max(TimeGenerated, Val) by Name, Database, Instance, Computer\r\n| extend Val = iff(Name == 'uptime', iff(LastTimestamp < now() - 10m , 0.0, 1.0), Val)\r\n| summarize CurrentOnline = sumif(Val, Name == 'uptime'),\r\n    EngineEdition = sumif(Val, Name == 'engine_edition')\r\n  by Database, Instance, Computer\r\n| where EngineEdition == 5\r\n| summarize Online = sum(CurrentOnline), Total = count()\r\n| extend Type = \"Azure SQL Databases\", Unhealthy = Total - Online\r\n| join kind = rightouter (dbsInGroup) on Type\r\n| extend Online = iff(Type == '', 0.0, Online),\r\n    Unhealthy = iff(Type == '', 0.0, Unhealthy),\r\n    Total = iff(Type == '', 0, Total),\r\n    Type = Type1\r\n\r\n",
                    "size": 4,
                    "title": "Azure SQL Databases",
                    "timeContext": {
                      "durationMs": 14400000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "visualization": "tiles",
                    "sortBy": [],
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Type",
                        "formatter": 1,
                        "formatOptions": {
                          "linkTarget": "WorkbookTemplate",
                          "workbookContext": {
                            "componentIdSource": "workbook",
                            "resourceIdsSource": "parameter",
                            "resourceIds": "MonitoringProfile",
                            "templateIdSource": "static",
                            "templateId": "Community-Workbooks/Workloads-AMA/Azure SQL databases",
                            "typeSource": "static",
                            "type": "workload-insights",
                            "gallerySource": "static",
                            "gallery": "Azure Monitor",
                            "locationSource": "default",
                            "passSpecificParams": true,
                            "templateParameters": [
                              {
                                "name": "MonitoringProfile",
                                "source": "parameter",
                                "value": "MonitoringProfile"
                              },
                              {
                                "name": "TimeRange",
                                "source": "parameter",
                                "value": "TimeRange"
                              },
                              {
                                "name": "SqlType",
                                "source": "column",
                                "value": "Type"
                              },
                              {
                                "name": "CommonErrors",
                                "source": "parameter",
                                "value": "CommonErrors"
                              }
                            ]
                          }
                        }
                      },
                      "subtitleContent": {
                        "columnMatch": "Subtitle",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Green",
                        "formatter": 22,
                        "formatOptions": {
                          "compositeBarSettings": {
                            "labelText": "[\"Total\"] database(s)",
                            "columnSettings": [
                              {
                                "columnName": "Online",
                                "color": "green"
                              },
                              {
                                "columnName": "Unhealthy",
                                "color": "yellow"
                              }
                            ]
                          }
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false,
                            "maximumFractionDigits": 1
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Currently unhealthy dbs",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            {
                              "operator": ">",
                              "thresholdValue": "0",
                              "representation": "Blank",
                              "text": "{0}{1}"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "Blank",
                              "text": ""
                            }
                          ]
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "showBorder": false
                    }
                  },
                  "name": "Azure SQL Databases"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let dbsInGroup = datatable(Type:string)[\r\n  \"Managed Instances\"\r\n];\r\nlet data = InsightsMetrics\r\n| where Computer in~ ({OnboardedComputers})\r\n| where Namespace contains 'sqlserver_server_properties'\r\n| extend Tags = todynamic(Tags)\r\n| extend Database = tostring(Tags.database_name), Instance = tostring(Tags.sql_instance)\r\n| extend DatabaseKey = iff(Database == Instance, Database, strcat(Database, ' on ', Instance));\r\ndata\r\n| summarize (LastTimestamp, Val) = arg_max(TimeGenerated, Val) by Name, Database, Instance, Computer\r\n| extend Val = iff(LastTimestamp < now() - 10m and Name != 'engine_edition', 0.0, Val)\r\n| summarize CurrentOnline = sumif(Val, Name == 'db_online'),\r\n    CurrentUnhealthy = sumif(Val, Name in~ ('db_offline', 'db_recovering', 'db_recoveryPending', 'db_restoring', 'db_suspect')),\r\n    EngineEdition = sumif(Val, Name == 'engine_edition')\r\n  by Database, Instance, Computer\r\n| extend CurrentOnline = iff(EngineEdition == 5 and CurrentOnline > 0, 1.0, CurrentOnline)\r\n| extend Key = strcat(Computer, '/', Instance, '/', Database)\r\n| join kind = inner (data\r\n    | summarize OverallOnline = minif(Val, Name == 'db_online'),\r\n                OverallUnhealthy = maxif(Val, Name in~ ('db_offline', 'db_recovering', 'db_recoveryPending', 'db_restoring', 'db_suspect')),\r\n                EngineEdition = sumif(Val, Name == 'engine_edition')\r\n    by Key = strcat(Computer, '/', Instance, '/', Database)\r\n) on Key\r\n| extend CurrentOnline = iff(EngineEdition == 5 and CurrentOnline > 0, 1.0, CurrentOnline), OverallOnline = iff(EngineEdition == 5 and OverallOnline > 0, 1.0, OverallOnline)\r\n| project-away Key, Key1, EngineEdition1\r\n| extend Type = case(\r\n            EngineEdition in (1, 2, 3, 4), 'SQL Server Instances',\r\n            EngineEdition in (5, 6, 9), 'Azure SQL Databases',\r\n            EngineEdition == 8, 'Managed Instances',\r\n            'Other')\r\n| project Database = strcat(Instance, '/', Database), Green = CurrentOnline, Yellow = OverallUnhealthy - CurrentUnhealthy, Red = CurrentUnhealthy, Total = CurrentOnline + CurrentUnhealthy, Gray =  (OverallOnline + OverallUnhealthy) - (CurrentOnline + CurrentUnhealthy), Type, Computer\r\n| summarize Green = sum(Green), Yellow = sum(Yellow), Red = sum(Red), Gray = sum(Gray), Total = sum(Total) by Type\r\n| join kind = rightouter(dbsInGroup) on Type\r\n| extend Type = iff(Type == '', Type1, Type),\r\n    Yellow = iff(Type == '', 0.0, Yellow),\r\n    Red = iff(Type == '', 0.0, Red),\r\n    Gray = iff(Type == '', 0.0, Gray),\r\n    Green = iff(Type == '', 0.0, Green),\r\n    Total = iff(Type == '', 0.0, Total)\r\n| summarize ['Online dbs'] = sum(Green), ['Previously unhealthy dbs'] = sum(Yellow), ['Currently unhealthy dbs'] = sum(Red), [\"No telemetry dbs\"] = sum(Gray), Total = sum(Total) by Type\r\n| extend Subtitle = '━━━'\r\n| order by ['Currently unhealthy dbs'] desc, [\"No telemetry dbs\"] desc, ['Previously unhealthy dbs'] desc, ['Online dbs'] desc\r\n",
                    "size": 4,
                    "title": "Azure SQL Managed Instances",
                    "timeContext": {
                      "durationMs": 14400000
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "visualization": "tiles",
                    "sortBy": [],
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Type",
                        "formatter": 1,
                        "formatOptions": {
                          "linkTarget": "WorkbookTemplate",
                          "workbookContext": {
                            "componentIdSource": "workbook",
                            "resourceIdsSource": "parameter",
                            "resourceIds": "MonitoringProfile",
                            "templateIdSource": "static",
                            "templateId": "Community-Workbooks/Workloads-AMA/Azure SQL Managed Instances",
                            "typeSource": "static",
                            "type": "workload-insights",
                            "gallerySource": "static",
                            "gallery": "Azure Monitor",
                            "locationSource": "default",
                            "passSpecificParams": true,
                            "templateParameters": [
                              {
                                "name": "MonitoringProfile",
                                "source": "parameter",
                                "value": "MonitoringProfile"
                              },
                              {
                                "name": "TimeRange",
                                "source": "parameter",
                                "value": "TimeRange"
                              },
                              {
                                "name": "SqlType",
                                "source": "column",
                                "value": "Type"
                              },
                              {
                                "name": "CommonErrors",
                                "source": "parameter",
                                "value": "CommonErrors"
                              }
                            ]
                          }
                        }
                      },
                      "leftContent": {
                        "columnMatch": "Green",
                        "formatter": 22,
                        "formatOptions": {
                          "compositeBarSettings": {
                            "labelText": "[\"Total\"] database(s)",
                            "columnSettings": [
                              {
                                "columnName": "Online dbs",
                                "color": "green"
                              },
                              {
                                "columnName": "No telemetry dbs",
                                "color": "orange"
                              },
                              {
                                "columnName": "Previously unhealthy dbs",
                                "color": "yellow"
                              },
                              {
                                "columnName": "Currently unhealthy dbs",
                                "color": "redBright"
                              }
                            ]
                          }
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false,
                            "maximumFractionDigits": 1
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Currently unhealthy dbs",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            {
                              "operator": ">",
                              "thresholdValue": "0",
                              "representation": "Blank",
                              "text": "{0}{1}"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "Blank",
                              "text": ""
                            }
                          ]
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "showBorder": false
                    }
                  },
                  "name": "Azure SQL Managed Instances"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let dbsInGroup = datatable(Type: string)[\r\n    \"SQL Server Instances\",\r\n    \"Availability Groups\"\r\n    ];\r\nlet aGdata = InsightsMetrics\r\n    | where Computer in~ ({OnboardedComputers})\r\n    | where Namespace == \"sqlserver_hadr_replica_states\" and Name == \"role\" and Val == \"1\"\r\n    | extend Tags = todynamic(Tags)\r\n    | extend SyncHealth = tostring(Tags.ag_synchronization_health_desc)\r\n    | extend GroupId = tostring(Tags.group_id), GroupName = tostring(Tags.group_name);\r\nlet aGStatus = aGdata\r\n    | where TimeGenerated between(ago(10m)..now())\r\n    | extend isHealthy = iff(SyncHealth == \"HEALTHY\", 1, 0)\r\n    | summarize CurrentOnline = min(isHealthy), CurrentTotal = max(isHealthy) by GroupId, Computer, GroupName\r\n    | join kind = inner (\r\n        aGdata\r\n        | extend isHealthy = iff(SyncHealth == \"HEALTHY\", 1, 0)\r\n        | summarize OverallOnline = min(isHealthy), OverallTotal = max(isHealthy) by GroupId, Computer, GroupName)\r\n        on GroupId\r\n    | extend Type = \"Availability Groups\"\r\n    | extend OverallUnhealthy = OverallTotal - OverallOnline\r\n    | extend CurrentUnhealthy = CurrentTotal - CurrentOnline\r\n    | project Green = CurrentOnline, Yellow = OverallUnhealthy - CurrentUnhealthy, Red = CurrentUnhealthy, Total = CurrentTotal, Gray =  (OverallTotal) - (CurrentTotal), Type, Computer\r\n    | summarize Green = sum(Green), Yellow = sum(Yellow), Red = sum(Red), Gray = sum(Gray), Total = sum(Total) by Type;\r\nlet data = InsightsMetrics\r\n    | where Computer in~ ({OnboardedComputers})\r\n    | where Namespace contains 'sqlserver_server_properties'\r\n    | extend Tags = todynamic(Tags)\r\n    | extend Database = tostring(Tags.database_name), Instance = tostring(Tags.sql_instance)\r\n    | extend DatabaseKey = iff(Database == Instance, Database, strcat(Database, ' on ', Instance));\r\ndata\r\n| summarize (LastTimestamp, Val) = arg_max(TimeGenerated, Val) by Name, Database, Instance, Computer\r\n| extend Val = iff(LastTimestamp < now() - 10m and Name != 'engine_edition', 0.0, Val)\r\n| summarize CurrentOnline = sumif(Val, Name == 'db_online'),\r\n    CurrentUnhealthy = sumif(Val, Name in~ ('db_offline', 'db_recovering', 'db_recoveryPending', 'db_restoring', 'db_suspect')),\r\n    EngineEdition = sumif(Val, Name == 'engine_edition')\r\n    by Database, Instance, Computer\r\n| extend CurrentOnline = iff(EngineEdition == 5 and CurrentOnline > 0, 1.0, CurrentOnline)\r\n| extend Key = strcat(Computer, '/', Instance, '/', Database)\r\n| join kind = inner (\r\n    data\r\n    | summarize OverallOnline = minif(Val, Name == 'db_online'),\r\n        OverallUnhealthy = maxif(Val, Name in~ ('db_offline', 'db_recovering', 'db_recoveryPending', 'db_restoring', 'db_suspect')),\r\n        EngineEdition = sumif(Val, Name == 'engine_edition')\r\n        by Key = strcat(Computer, '/', Instance, '/', Database)\r\n    )\r\n    on Key\r\n| extend CurrentOnline = iff(EngineEdition == 5 and CurrentOnline > 0, 1.0, CurrentOnline), OverallOnline = iff(EngineEdition == 5 and OverallOnline > 0, 1.0, OverallOnline)\r\n| project-away Key, Key1, EngineEdition1\r\n| extend Type = case(\r\n    EngineEdition in (1, 2, 3, 4), 'SQL Server Instances',\r\n    EngineEdition in (5, 6, 9), 'Azure SQL Databases',\r\n    EngineEdition == 8, 'Azure SQL Managed Instances',\r\n    'Other')\r\n| project Database = strcat(Instance, '/', Database), Green = CurrentOnline, Yellow = OverallUnhealthy - CurrentUnhealthy, Red = CurrentUnhealthy, Total = CurrentOnline + CurrentUnhealthy, Gray =  (OverallOnline + OverallUnhealthy) - (CurrentOnline + CurrentUnhealthy), Type, Computer\r\n| summarize Green = sum(Green), Yellow = sum(Yellow), Red = sum(Red), Gray = sum(Gray), Total = sum(Total) by Type\r\n| join kind = rightouter (dbsInGroup) on Type\r\n| extend Type = iff(Type == '', Type1, Type),\r\n    Yellow = iff(Type == '', 0, tolong(Yellow)),\r\n    Red = iff(Type == '', 0, tolong(Red)),\r\n    Gray = iff(Type == '', 0, tolong(Gray)),\r\n    Green = iff(Type == '', 0, tolong(Green)),\r\n    Total = iff(Type == '', 0, tolong(Total))\r\n| join kind = leftouter (aGStatus) on Type\r\n| extend Yellow = iff(isempty(Yellow1), Yellow, tolong(Yellow1)),\r\n    Red = iff(isempty(Red1), Red, tolong(Red1)),\r\n    Gray = iff(isempty(Gray1), Gray, tolong(Gray1)),\r\n    Green = iff(isempty(Green1), Green, tolong(Green1)),\r\n    Total = iff(isempty(Total1), Total, tolong(Total1))\r\n| summarize ['Online dbs'] = sum(Green), ['Previously unhealthy dbs'] = sum(Yellow), ['Currently unhealthy dbs'] = sum(Red), [\"No telemetry dbs\"] = sum(Gray), Total = sum(Total) by Type\r\n| extend Subtitle = '━━━'\r\n| extend TemplateLink = case(Type == 'SQL Server Instances', 'Community-Workbooks/Workloads-AMA/SQL Servers', 'Community-Workbooks/Workloads-AMA/Availability Groups')\r\n| extend Units = case(Type == 'SQL Server Instances', 'database(s)', 'availability group(s)')\r\n| order by ['Currently unhealthy dbs'] desc, [\"No telemetry dbs\"] desc, ['Previously unhealthy dbs'] desc, ['Online dbs'] desc, ['Type'] desc\r\n",
                    "size": 4,
                    "title": "Self Managed SQL (Azure and On-Premise)",
                    "timeContext": {
                      "durationMs": 0
                    },
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{Workspaces}"
                    ],
                    "visualization": "tiles",
                    "sortBy": [],
                    "tileSettings": {
                      "titleContent": {
                        "columnMatch": "Type",
                        "formatter": 1,
                        "formatOptions": {
                          "linkTarget": "WorkbookTemplate",
                          "workbookContext": {
                            "componentIdSource": "workbook",
                            "resourceIdsSource": "parameter",
                            "resourceIds": "MonitoringProfile",
                            "templateIdSource": "column",
                            "templateId": "TemplateLink",
                            "typeSource": "static",
                            "type": "workload-insights",
                            "gallerySource": "static",
                            "gallery": "Azure Monitor",
                            "locationSource": "default",
                            "passSpecificParams": true,
                            "templateParameters": [
                              {
                                "name": "MonitoringProfile",
                                "source": "parameter",
                                "value": "MonitoringProfile"
                              },
                              {
                                "name": "TimeRange",
                                "source": "parameter",
                                "value": "TimeRange"
                              },
                              {
                                "name": "SqlType",
                                "source": "column",
                                "value": "Type"
                              },
                              {
                                "name": "CommonErrors",
                                "source": "parameter",
                                "value": "CommonErrors"
                              }
                            ]
                          }
                        }
                      },
                      "leftContent": {
                        "columnMatch": "Green",
                        "formatter": 22,
                        "formatOptions": {
                          "compositeBarSettings": {
                            "labelText": "[\"Total\"] [\"Units\"]",
                            "columnSettings": [
                              {
                                "columnName": "Online dbs",
                                "color": "green"
                              },
                              {
                                "columnName": "No telemetry dbs",
                                "color": "orange"
                              },
                              {
                                "columnName": "Previously unhealthy dbs",
                                "color": "yellow"
                              },
                              {
                                "columnName": "Currently unhealthy dbs",
                                "color": "redBright"
                              }
                            ]
                          }
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false,
                            "maximumFractionDigits": 1
                          }
                        }
                      },
                      "secondaryContent": {
                        "columnMatch": "Currently unhealthy dbs",
                        "formatter": 18,
                        "formatOptions": {
                          "thresholdsOptions": "icons",
                          "thresholdsGrid": [
                            {
                              "operator": ">",
                              "thresholdValue": "0",
                              "representation": "Blank",
                              "text": "{0}{1}"
                            },
                            {
                              "operator": "Default",
                              "thresholdValue": null,
                              "representation": "Blank",
                              "text": ""
                            }
                          ]
                        },
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      "showBorder": false
                    }
                  },
                  "name": "Self Managed SQL "
                }
              ]
            },
            "conditionalVisibilities": [
              {
                "parameterName": "OnboardedComputers",
                "comparison": "isNotEqualTo"
              },
              {
                "parameterName": "Workspaces",
                "comparison": "isNotEqualTo"
              }
            ],
            "name": "OnboardedComputers"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "Overview",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "template",
        "loadFromTemplateId": "Community-Workbooks/Workloads-AMA/Enable monitoring",
        "items": []
      },
      "conditionalVisibilities": [
        {
          "parameterName": "MonitoringProfile",
          "comparison": "isNotEqualTo"
        },
        {
          "parameterName": "selectedTab",
          "comparison": "isEqualTo",
          "value": "Manage profile"
        }
      ],
      "name": "Manage profile"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}