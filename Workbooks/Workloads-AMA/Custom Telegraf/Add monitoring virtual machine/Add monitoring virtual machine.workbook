{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{MonitoringProfile}"
        ],
        "parameters": [
          {
            "id": "5a0bb93e-4a4f-4b69-a5a6-49fb85e0c7f4",
            "version": "KqlParameterItem/1.0",
            "name": "MonitoringProfile",
            "type": 5,
            "isRequired": true,
            "value": null,
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "88df9a87-9c9f-4b69-918e-eb6d70e5c1c5",
            "version": "KqlParameterItem/1.0",
            "name": "MonitoringProfileSub",
            "type": 1,
            "description": "Set the default subscription retrieved from Custom telegraf monitoring Template",
            "value": "",
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            }
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "parameters - 6"
    },
    {
      "type": 1,
      "content": {
        "json": "### Select virtual machine\r\nSelect a virtual machine you would like for monitoring."
      },
      "name": "text - 1"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{Subscription}"
        ],
        "parameters": [
          {
            "id": "0a001304-7d24-4e0c-9efc-2084cfbb6f79",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "query": "Resources\r\n| summarize Count = countif(type =~ 'microsoft.compute/virtualmachines') by subscriptionId\r\n| order by Count desc\r\n| extend Row = row_number()\r\n| project value = subscriptionId, label = subscriptionId, selected = iif(isempty('{MonitoringProfileSub}'), Row == 1, '{MonitoringProfileSub}' contains subscriptionId)",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "VmId",
            "label": "Virtual machine",
            "type": 5,
            "isRequired": true,
            "query": "Resources\r\n| where type =~ 'microsoft.compute/virtualmachines' and location in (dynamic(['australiasoutheast','centralus', 'eastus','eastus2','eastus2euap','northeurope','southeastasia','uksouth','westeurope','westus','westus2'])) \r\n| order by resourceGroup asc, name asc\r\n| project value = id, label = name, selected = false, group = resourceGroup",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "value": null,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "id": "ab183818-7288-4442-949c-0f5fbbd0d887"
          },
          {
            "id": "19eaf053-5e01-4631-b24d-ec7ee04597c5",
            "version": "KqlParameterItem/1.0",
            "name": "VmLocation",
            "type": 1,
            "isRequired": true,
            "query": "Resources\r\n| where id =~ '{VmId}'\r\n| project value = location, label = location, selected = true",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "e625a983-193e-46b5-b7b0-d7fb3536f1eb",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "label": "Resource group",
            "type": 5,
            "isRequired": true,
            "query": "Resources\r\n| where id =~ '{VmId}'\r\n| project id = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\r\n| project value = id, label = id, selected = true",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "9aa90695-2b17-44e9-a468-ebf8270c69b1",
            "version": "KqlParameterItem/1.0",
            "name": "vmOS",
            "type": 1,
            "query": "Resources\r\n| where id =~ '{VmId}'\r\n| extend offer = properties.storageProfile.imageReference.offer\r\n| extend sku = properties.storageProfile.imageReference.sku\r\n| project iff(isnotempty(offer) and isnotempty(sku), strcat(\"The operating system on the virtual machine is \", offer, \" \", sku, \".\"), \"\") ",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          }
        ],
        "style": "formVertical",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "customWidth": "60",
      "name": "parameters - 2"
    },
    {
      "type": 1,
      "content": {
        "json": "{vmOS} The recommended virtual machine OS is Ubuntu 18.04-LTS.",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "vmOS",
        "comparison": "isNotEqualTo",
        "value": "The operating system on the virtual machine is UbuntuServer 18.04-LTS."
      },
      "name": "Recommend vm version message"
    },
    {
      "type": 1,
      "content": {
        "json": "#### Add secrets and parameters\r\nAdd the monitoring config for this virtual machine. It involves providing a set of connection strings for the databases you would like to monitor. \r\n\r\nNote that you have the option to define parameters to reference secrets from an Azure Key Vault or for just reuse of tokens across connection strings. [Learn more](https://github.com/acearun/managedsolutions/blob/master/Documentation/Workloads/wli-configs.md)"
      },
      "name": "text - 3"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::all"
        ],
        "parameters": [
          {
            "id": "ceb4f028-a3cb-4e49-b5f7-d018a660502d",
            "version": "KqlParameterItem/1.0",
            "name": "savedConfig",
            "type": 1,
            "isRequired": true,
            "query": "Resources\r\n| where id =~ strcat('{VmId}','/extensions/Workload.WLILinuxExtension') and name =~ 'Workload.WLILinuxExtension' and type =~ 'microsoft.compute/virtualmachines/extensions'\r\n| project tostring(properties.settings.workloadConfig)",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "multiLineText": true,
              "editorLanguage": "json",
              "multiLineHeight": 15,
              "preFormatJsonData": true
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "savedConfig"
    },
    {
      "type": 1,
      "content": {
        "json": "Please configure using the template below.",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "savedConfig",
        "comparison": "isEqualTo"
      },
      "name": "Saved config not found message"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "ef5f9e5a-8298-4993-aa2d-bd20d69c8f3f",
            "version": "KqlParameterItem/1.0",
            "name": "PerVmConfig",
            "label": "Secrets and parameters",
            "type": 1,
            "isRequired": true,
            "value": "{\n    \"version\": 1,\n    \"secrets\": {\n    },\n    \"parameters\": {\n    }\n}",
            "typeSettings": {
              "multiLineText": true,
              "editorLanguage": "json",
              "multiLineHeight": 15
            },
            "timeContext": {
              "durationMs": 86400000
            }
          }
        ],
        "style": "formVertical",
        "queryType": 0,
        "resourceType": "microsoft.insights/datacollectionrules"
      },
      "conditionalVisibility": {
        "parameterName": "savedConfig",
        "comparison": "isEqualTo"
      },
      "customWidth": "90",
      "name": "Connection strings"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "4d03e768-7350-40c3-b44e-0eff614645ae",
            "version": "KqlParameterItem/1.0",
            "name": "Config",
            "label": "Current monitoring configuration",
            "type": 1,
            "typeSettings": {
              "multiLineText": true,
              "editorLanguage": "json",
              "multiLineHeight": 15
            },
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "savedConfig",
                  "operator": "isNotNull",
                  "rightValType": "param",
                  "resultValType": "param",
                  "resultVal": "savedConfig"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "rightValType": "param",
                  "resultValType": "param",
                  "resultVal": "PerVmConfig"
                }
              }
            ],
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "b267e868-5a38-462e-b506-957caa359c7f",
            "version": "KqlParameterItem/1.0",
            "name": "isValidJson",
            "type": 1,
            "value": "false",
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "Config",
                  "operator": "isValidJson",
                  "rightValType": "param",
                  "resultValType": "static",
                  "resultVal": "true"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "rightValType": "param",
                  "resultValType": "static",
                  "resultVal": "false"
                }
              }
            ],
            "timeContext": {
              "durationMs": 86400000
            }
          }
        ],
        "style": "formVertical",
        "queryType": 0,
        "resourceType": "microsoft.compute/virtualmachines"
      },
      "conditionalVisibility": {
        "parameterName": "savedConfig",
        "comparison": "isNotEqualTo"
      },
      "name": "Final Config"
    },
    {
      "type": 1,
      "content": {
        "json": "Please ensure the configuration is a valid JSON before proceeding.",
        "style": "error"
      },
      "conditionalVisibility": {
        "parameterName": "isValidJson",
        "comparison": "isEqualTo",
        "value": "false"
      },
      "name": "Check Json"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "#### Enable access to Azure Key Vaults (Optional)\nIf your connection strings reference secrets from Key Vaults, you need to provide access to it from the virtual machine via a Managed Service Identity."
            },
            "name": "Key vault access label"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "value::all"
              ],
              "parameters": [
                {
                  "id": "7886d36e-4db3-43e4-813b-c6427ac0cf0b",
                  "version": "KqlParameterItem/1.0",
                  "name": "KeyVaultSubscriptions",
                  "label": "Key vault subscriptions",
                  "type": 6,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "includeAll": true,
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "d082b467-a4fc-4023-869f-d97476f10e9b",
                  "version": "KqlParameterItem/1.0",
                  "name": "KeyVaults",
                  "type": 5,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "Resources\n| where type =~ 'microsoft.keyvault/vaults'\n| order by resourceGroup asc, name asc\n| project value = id, label = id, selected = false, group = resourceGroup",
                  "crossComponentResources": [
                    "{KeyVaultSubscriptions}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                },
                {
                  "id": "14eddd17-2dc7-467b-bc41-f302a75d6b79",
                  "version": "KqlParameterItem/1.0",
                  "name": "KvDetails",
                  "type": 1,
                  "query": "Resources\n| where id in~ (dynamic([{KeyVaults:value}]))\n| summarize tostring(makelist(pack('name', name, 'subscription', subscriptionId, 'resourceGroup', resourceGroup)))",
                  "crossComponentResources": [
                    "value::all"
                  ],
                  "isHiddenWhenLocked": true,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                }
              ],
              "style": "formVertical",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "customWidth": "60",
            "name": "Key vault parameters"
          },
          {
            "type": 1,
            "content": {
              "json": "#### Enable monitoring from this virtual machine\n\nUse the button below to deploy the required components and start monitoring."
            },
            "name": "Enable monitoring label",
            "styleSettings": {
              "margin": "10px 0 0 0"
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "paragraph",
              "links": [
                {
                  "id": "e95dc155-3fda-479a-9beb-ba9a851ee930",
                  "linkTarget": "ArmTemplate",
                  "linkLabel": "Add monitoring virtual machine",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "templateRunContext": {
                    "componentIdSource": "parameter",
                    "componentId": "ResourceGroup",
                    "templateUriSource": "static",
                    "templateUri": "Community-Workbooks/Workloads-AMA/Create new profile/AddMonitoringVirtualMachine.armtemplate",
                    "templateParameters": [
                      {
                        "name": "vmName",
                        "source": "static",
                        "value": "{VmId:name}",
                        "kind": "stringValue"
                      },
                      {
                        "name": "dataCollectionRuleId",
                        "source": "parameter",
                        "value": "MonitoringProfile",
                        "kind": "stringValue"
                      },
                      {
                        "name": "workloadconfig",
                        "source": "parameter",
                        "value": "Config",
                        "kind": "objectValue"
                      },
                      {
                        "name": "vmLocation",
                        "source": "parameter",
                        "value": "VmLocation",
                        "kind": "stringValue"
                      },
                      {
                        "name": "vmSubscription",
                        "source": "static",
                        "value": "{VmId:subscription}",
                        "kind": "stringValue"
                      },
                      {
                        "name": "vmResourceGroup",
                        "source": "static",
                        "value": "{VmId:resourceGroup}",
                        "kind": "stringValue"
                      },
                      {
                        "name": "linkedVaults",
                        "source": "parameter",
                        "value": "KvDetails",
                        "kind": "arrayValue"
                      }
                    ],
                    "title": "Enable monitoring on virtual machine",
                    "descriptionSource": "static",
                    "description": "All set to use **{VmId:name}** to start monitoring.\r\n\r\nThe ARM template used to deploy the workload insights extension can be inspected by clicking on the `View Template`.\r\n\r\nClick the `Start monitoring` button to onboard this virtual machine to the monitoring profile and begin monitoring.\r\n\r\n> **Note:** This process may take up to 2 minutes. Please refresh the workbook to see the onboarded virtual machine.",
                    "runLabelSource": "static",
                    "runLabel": "Start monitoring"
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "isValidJson",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "links - 5"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "isValidJson",
        "comparison": "isEqualTo",
        "value": "true"
      },
      "name": "Steps after valid json"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}