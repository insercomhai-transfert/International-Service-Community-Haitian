{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::selected"
        ],
        "parameters": [
          {
            "id": "b799771e-b262-4a16-8a01-e2ebaca03038",
            "version": "KqlParameterItem/1.0",
            "name": "DatabaseId",
            "label": "Database id",
            "type": 5,
            "isRequired": true,
            "value": "value::1",
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::1"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "7b33f159-2efc-4eda-8475-84a9fc00e5e4",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 14400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                }
              ],
              "allowCustom": true
            }
          },
          {
            "id": "07e3985b-ac8d-4b48-afa7-ac49286ad2e1",
            "version": "KqlParameterItem/1.0",
            "name": "WorkspaceId",
            "type": 1,
            "query": "Resources\r\n| take 1\r\n| project value = extract(@'/workspace/(.+)/computer/.+/sqlinstance/.+/database/.*', 1, '{DatabaseId}')",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "Computer",
            "type": 1,
            "query": "Resources\r\n| take 1\r\n| project value = extract(@'/workspace/.+/computer/(.+)/sqlinstance/.+/database/.*', 1, '{DatabaseId}')",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "id": "99fba200-20d5-4385-9014-686c1950f7eb"
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "SqlInstance",
            "type": 1,
            "query": "Resources\r\n| take 1\r\n| project value = extract(@'/workspace/.+/computer/.+/sqlinstance/(.+)/database/.*', 1, '{DatabaseId}')",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "id": "411808ff-e620-40d8-92af-3de7dbcc84f5"
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "SqlDatabase",
            "type": 1,
            "query": "Resources\r\n| take 1\r\n| project value = extract(@'/workspace/.+/computer/.+/sqlinstance/.+/database/(.*)', 1, '{DatabaseId}')",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "id": "ef294ba3-ec6b-4b26-be52-1db5c77297ef"
          },
          {
            "id": "735e6c9c-ed77-48bb-aaad-641c9ec7972a",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "query": "Resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces' and properties.customerId == '{WorkspaceId}'",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "72a01604-7df5-4e7d-b8cc-73905b4c0cc9",
            "version": "KqlParameterItem/1.0",
            "name": "selectedTab",
            "type": 1,
            "isHiddenWhenLocked": true          }
          {
            "id": "29aed974-abed-4045-a34a-f9df3333b4da",
            "version": "KqlParameterItem/1.0",
            "name": "dbType",
            "type": 1,
            "isHiddenWhenLocked": true,
            "value": "AzureSQLDB"
          },
          {
            "id": "32dbda4c-81a5-4811-a8eb-97f52410c729",
            "version": "KqlParameterItem/1.0",
            "name": "Resources_queries",
            "type": 9,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "where type contains 'MICROSOFT.SQL/SERVERS'\r\n| extend ResourceId = tolower(id)\r\n| extend name = tolower(strcat(extract(tolower('/microsoft.sql/servers/([^/]+)/'), 1, ResourceId), '/', name))\r\n| where name == tolower(strcat('{SqlInstance}', '/', '{SqlDatabase}'))\r\n| project strcat('{\"name\":\"',name, '\" , \"subscription\": \"', subscriptionId, '\", \"resourceGroup\": \"', resourceGroup, '\"}')\r\n",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "Parameter block",
      "styleSettings": {
        "margin": "0 0 15px 0"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let Names = dynamic(['avg_cpu_percent', 'avg_instance_cpu_percent']);\r\nlet data = InsightsMetrics\r\n| extend Tags = todynamic(Tags)\r\n| extend Database = tostring(Tags.database_name), Instance = tostring(Tags.sql_instance)\r\n| extend DatabaseKey = iff(Database == Instance, Database, strcat(Database, ' on ', Instance))\r\n| where Instance == '{SqlInstance}'\r\n| where Namespace =~ 'sqlserver_azure_db_resource_stats' and (Computer == '{Computer}' or '*' == '{Computer}') and Name in (Names)\r\n| extend SeriesName = 'SQL CPU';\r\ndata\r\n| summarize Average = avg(Val) by SeriesName\r\n| join kind= inner (data\r\n    | make-series Trend = avg(Val) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SeriesName) on SeriesName\r\n| project SeriesName, Average, Trend\r\n\r\n",
        "size": 4,
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "SeriesName",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Trend",
            "formatter": 9,
            "formatOptions": {
              "palette": "blue"
            }
          },
          "secondaryContent": {
            "columnMatch": "Average",
            "formatter": 12,
            "formatOptions": {
              "palette": "blue"
            },
            "numberFormat": {
              "unit": 1,
              "options": {
                "style": "decimal",
                "useGrouping": false
              }
            }
          },
          "showBorder": false,
          "sortCriteriaField": "Name",
          "sortOrderField": 1
        }
      },
      "name": "query - 3"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "6a802fb2-aff0-4d4c-ac50-cff64d3722b6",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "SQL",
            "subTarget": "SQL",
            "style": "link"
          }
        ]
      },
      "name": "Tabs"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let resources = print dynamic([{Resources_queries}])\r\n| mv-expand print_0\r\n| evaluate bag_unpack(print_0);\r\nInsightsMetrics\r\n| where Origin contains 'solutions.azm.ms/telegraf'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_runtime_stats'\r\n| summarize make_bag( pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| extend resourceName = tolower(strcat(extract(\"^([^\\\\.]+)\\\\.?\", 1, sql_instance), '/', database_name))\r\n| join kind=leftouter (resources| extend resourceName = name)on resourceName\r\n| where tostring(sql_instance) == '{SqlInstance}'\r\n| where tostring(database_name) == '{SqlDatabase}'\r\n| summarize max_duration = max(max_duration)/1000000,\r\navg_duration = sum(avg_duration*count_executions)/sum(count_executions)/1000000,\r\navg_cpu = sum(avg_cpu_time*count_executions)/sum(count_executions)/1000000,\r\nexecutions_count = sum(count_executions)\r\n    by query_hash\r\n| project query_hash,\r\n    max_duration,\r\n    avg_duration,\r\n    avg_cpu,\r\n    executions_count,\r\n    wbLink = 'Community-Workbooks/Workloads-AMA/Query Details'\r\n| sort by avg_duration desc",
              "size": 0,
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "50",
            "name": "TODO: Query details table"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let Names = dynamic(['avg_cpu_percent', 'avg_instance_cpu_percent']);\r\nlet data = InsightsMetrics\r\n| extend Tags = todynamic(Tags)\r\n| extend Database = tostring(Tags.database_name), Instance = tostring(Tags.sql_instance)\r\n| extend DatabaseKey = iff(Database == Instance, Database, strcat(Database, ' on ', Instance))\r\n| where Instance == '{SqlInstance}'\r\n| where Namespace =~ 'sqlserver_azure_db_resource_stats' and (Computer == '{Computer}' or '*' == '{Computer}') and Name in (Names);\r\ndata\r\n| extend SeriesName = strcat(Instance, '/', Database)\r\n| summarize Val = avg(Val) by bin(TimeGenerated, 5m), SeriesName, Name\r\n| make-series Trend = avg(Val) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by Name, SeriesName",
              "size": 1,
              "aggregation": 3,
              "showAnalytics": true,
              "title": "CPU Utilization %",
              "timeContext": {
                "durationMs": 14400000
              },
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "avg_instance_cpu_percent",
                    "label": "Instance CPU %"
                  },
                  {
                    "seriesName": "avg_cpu_percent",
                    "label": "CPU %"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "maximumFractionDigits": 2
                    }
                  },
                  "min": 0
                }
              }
            },
            "customWidth": "50",
            "showPin": true,
            "name": "CPU Utilization %"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "SQL"
      },
      "name": "SQL Group"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}