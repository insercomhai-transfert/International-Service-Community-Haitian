{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Enable SQL monitoring"
      },
      "name": "text - 1",
      "styleSettings": {
        "margin": "15px 0 0 0"
      }
    },
    {
      "type": 1,
      "content": {
        "json": "### 1. Create monitoring profile\nA profile allows you to group SQL Servers or databases to monitor and analyze as a combined set. It allows you to set the scope of monitoring - whether it is collection environments (development or production), application (billing or customer), the collection settings (e.g. high fidelity data collection vs. low), etc. "
      },
      "name": "text - 4",
      "styleSettings": {
        "margin": "15px 0 5px 0"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{ProfileSubscription}"
        ],
        "parameters": [
          {
            "id": "748b3ba7-7333-4397-9dc6-e5e9eef468d7",
            "version": "KqlParameterItem/1.0",
            "name": "ProfileSubscription",
            "label": "Subscription",
            "type": 6,
            "isRequired": true,
            "query": "Resources\n| summarize Count = countif(type =~ 'microsoft.insights/datacollectionrules') by subscriptionId\n| order by Count desc\n| extend Row = row_number()\n| project value = subscriptionId, label = subscriptionId, selected = Row == 1\n",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "748b3ba7-7333-4397-9dc6-e5e9eef468d7",
            "version": "KqlParameterItem/1.0",
            "name": "ProfileResourceGroup",
            "label": "Resource group",
            "type": 5,
            "isRequired": true,
            "query": "Resources\n| summarize Count = countif(type =~ 'microsoft.insights/datacollectionrules') by resourceGroup = strcat('/subscriptions/', subscriptionId, '/resourceGroups/', resourceGroup)\n| order by Count desc\n| extend Row = row_number()\n| project value = resourceGroup, label = resourceGroup, selected = Row == 1\n",
            "crossComponentResources": [
              "{ProfileSubscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "b750335c-5b10-4e38-ab8f-4db314fbfc2f",
            "version": "KqlParameterItem/1.0",
            "name": "ProfileName",
            "label": "Profile name",
            "type": 1,
            "isRequired": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "value": ""
          },
          {
            "id": "77c2a6cf-83ad-48ea-87a0-37a59bbb1fd0",
            "version": "KqlParameterItem/1.0",
            "name": "ProfileLocation",
            "label": "Profile Location",
            "type": 8,
            "isRequired": true,
            "value": null,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n\"australiasoutheast\",\r\n\"eastus\",\r\n\"centralus\",\r\n\"westeurope\",\r\n\"westus2\",\r\n\"southeastasia\",\r\n\"eastus2\",\r\n\"uksouth\",\r\n\"northeurope\",\r\n\"westus\"\r\n]"
          },
          {
            "id": "350cc656-5650-4941-b6c4-455e37f6355c",
            "version": "KqlParameterItem/1.0",
            "name": "InsightTag",
            "label": "Insight tag",
            "type": 1,
            "isRequired": true,
            "value": "SqlInsights",
            "isHiddenWhenLocked": true
          },
          {
            "id": "e08ad21a-1696-4674-9104-066d372b94ac",
            "version": "KqlParameterItem/1.0",
            "name": "DestinationName",
            "label": "Destination name",
            "type": 1,
            "isRequired": true,
            "value": "SqlInsightsWorkspace",
            "isHiddenWhenLocked": true
          },
          {
            "id": "79dd10a3-751e-4dc2-8ab2-8f3a93319a1c",
            "version": "KqlParameterItem/1.0",
            "name": "DataSourceName",
            "label": "Data source name",
            "type": 1,
            "isRequired": true,
            "value": "SqlInsightsTelegrafData",
            "isHiddenWhenLocked": true
          }
        ],
        "style": "formVertical",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "customWidth": "60",
      "name": "Profile parameters"
    },
    {
      "type": 1,
      "content": {
        "json": "### 2. Set destination\nSpecify the Log Analytics workspace to send the SQL monitoring data to."
      },
      "name": "text - 4 - Copy",
      "styleSettings": {
        "margin": "15px 0 5px 0"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{WorkspaceSubscription}"
        ],
        "parameters": [
          {
            "id": "748b3ba7-7333-4397-9dc6-e5e9eef468d7",
            "version": "KqlParameterItem/1.0",
            "name": "WorkspaceSubscription",
            "label": "Workspace subscription",
            "type": 6,
            "isRequired": true,
            "query": "Resources\n| summarize by subscriptionId\n| project value = subscriptionId, label = subscriptionId, selected = strcat('/subscriptions/', subscriptionId) =~ '{ProfileSubscription}'\n",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "748b3ba7-7333-4397-9dc6-e5e9eef468d7",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "label": "Log Analytics workspace",
            "type": 5,
            "description": "Set the workspace to send SQL monitoring data to. This list is limited to the workspaces in the location of the SQL monitoring profile",
            "isRequired": true,
            "query": "Resources\n| where type =~ 'microsoft.operationalinsights/workspaces' and location == '{ProfileLocation}'\n| order by resourceGroup asc, name asc\n| project value = id, label = id, selected = false, group = resourceGroup",
            "crossComponentResources": [
              "{ProfileSubscription}"
            ],
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "161e7ff4-b6c2-4a5c-952b-f6c9c8a358cf",
            "version": "KqlParameterItem/1.0",
            "name": "WorkspaceId",
            "type": 1,
            "isRequired": true,
            "query": "Resources\n| where id =~ '{Workspace}'\n| project tostring(properties.customerId)",
            "crossComponentResources": [
              "{WorkspaceSubscription}"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          }
        ],
        "style": "formVertical",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "customWidth": "60",
      "name": "Profile parameters - Copy"
    },
    {
      "type": 1,
      "content": {
        "json": "### 3. Collection settings (Advanced)\nAllows you to customize SQL data collection for advanced scenarios. Note that this section does not need to be changed in normal cases. "
      },
      "name": "Configure collection",
      "styleSettings": {
        "margin": "15px 0 5px 0"
      }
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{ProfileSubscription}"
        ],
        "parameters": [
          {
            "id": "fe501246-9742-4ca4-bec3-4896566713af",
            "version": "KqlParameterItem/1.0",
            "name": "TelegrafConfig",
            "label": "Telegraf config",
            "type": 1,
            "isRequired": true,
            "typeSettings": {
              "multiLineText": true,
              "editorLanguage": "toml",
              "multiLineHeight": 12
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": "{{ $connections := .Parameters.connections }}\n[[inputs.sqlserver]]\n  servers = [\n    {{- range $ind, $cs := $connections }}\n    {{- if $ind}}, {{end}}\n\t\t\"{{ $cs }}\"\n\t\t{{- end}}\n\t]\n\tquery_version = 2\n\texclude_query = ['Schedulers', 'SqlRequests']\n\n[[inputs.cpu]]\n  percpu = true\n\ttotalcpu = true\n\tcollect_cpu_time = false\n\treport_active = false\n\t\n[[inputs.mem]]"
          }
        ],
        "style": "formVertical",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "customWidth": "90",
      "name": "Profile parameters - Copy - Copy"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "nav",
        "links": [
          {
            "id": "6474ffb5-8fbe-4154-b0d4-81cb82e894de",
            "linkTarget": "ArmTemplate",
            "linkLabel": "Create monitoring profile",
            "style": "primary",
            "linkIsContextBlade": true,
            "templateRunContext": {
              "componentIdSource": "parameter",
              "componentId": "ProfileResourceGroup",
              "templateUriSource": "static",
              "templateUri": "https://raw.githubusercontent.com/acearun/managedsolutions/master/Templates-Dcr/Create-profile/azuredeploy.json",
              "templateParameters": [
                {
                  "name": "dcrName",
                  "source": "parameter",
                  "value": "ProfileName",
                  "kind": "stringValue"
                },
                {
                  "name": "insight",
                  "source": "parameter",
                  "value": "InsightTag",
                  "kind": "stringValue"
                },
                {
                  "name": "destinationName",
                  "source": "parameter",
                  "value": "DestinationName",
                  "kind": "stringValue"
                },
                {
                  "name": "dataSource",
                  "source": "parameter",
                  "value": "DataSourceName",
                  "kind": "stringValue"
                },
                {
                  "name": "workspaceResourceId",
                  "source": "parameter",
                  "value": "Workspace",
                  "kind": "stringValue"
                },
                {
                  "name": "workspaceId",
                  "source": "parameter",
                  "value": "WorkspaceId",
                  "kind": "stringValue"
                },
                {
                  "name": "serializedTelegrafConfig",
                  "source": "parameter",
                  "value": "TelegrafConfig",
                  "kind": "stringValue"
                },
                {
                  "name": "dcrLocation",
                  "source": "parameter",
                  "value": "ProfileLocation",
                  "kind": "stringValue"
                }
              ],
              "titleSource": "static",
              "title": "Enable SQL monitoring",
              "descriptionSource": "static",
              "description": "All set to create your new SQL monitoring profile **{ProfileName}**. Click the `Create SQL monitoring profile` button below to create the profile.\n\n*Note: the ARM template used to deploy the profile can be inspected by clicking on the `View template` button below*",
              "runLabelSource": "static",
              "runLabel": "Create SQL monitoring profile"
            }
          }
        ]
      },
      "name": "Enable monitoring link"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}